<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Multi-site hierarchical calibration vignette • PEcAn.assim.batch</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Multi-site hierarchical calibration vignette">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">PEcAn.assim.batch</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.9.1.9000</small>

    <a href="../index.html" style="padding: 0em 1em">← Up</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/AssimBatchVignette.html">PEcAn.assim.batch Vignette</a></li>
    <li><a class="dropdown-item" href="../articles/MultiSitePDAVignette.html">Multi-site hierarchical calibration vignette</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Multi-site hierarchical calibration vignette</h1>
                        <h4 data-toc-skip class="author">Istem Fer</h4>
            
            <h4 data-toc-skip class="date">09/23/2019</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/PecanProject/pecan/blob/develop/modules/assim.batch/vignettes/MultiSitePDAVignette.Rmd" class="external-link"><code>vignettes/MultiSitePDAVignette.Rmd</code></a></small>
      <div class="d-none name"><code>MultiSitePDAVignette.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="multi-site-hierarchical-pda">Multi-Site Hierarchical PDA<a class="anchor" aria-label="anchor" href="#multi-site-hierarchical-pda"></a>
</h2>
<p>This vignette documents the steps and settings of Hierarchical
Bayesian Parameter Data Assimilation (HB-PDA) analysis on multiple
sites, and accompanies the paper.</p>
</div>
<div class="section level2">
<h2 id="initiate-a-new-run-from-the-web-interface">Initiate a new run from the web interface<a class="anchor" aria-label="anchor" href="#initiate-a-new-run-from-the-web-interface"></a>
</h2>
<p>Follow the steps:</p>
<pre><code>host : pecan
model : SIPNET (r136) # note I'll change this, because I want to make sure SIPNET code is also version controlled (which exact settings/modules I turned on/off etc.)
sitegroup : HB-PDA
site : US-Bar (choose any we will modify the xml in the next step)

CLICK NEXT

pft : soil.ALL, temperate.deciduous.ALL
start date : leave as it is
end date : leave as it is
pool_initial_condition : skip
Sipnet.climna: Use AmerifluxLBL

NOW CHECK THE EDIT XML TICK BOX AND CLICK NEXT
(Enter pecan for user name in the following page)</code></pre>
</div>
<div class="section level2">
<h2 id="start-with-multi-settings">Start with multi-settings<a class="anchor" aria-label="anchor" href="#start-with-multi-settings"></a>
</h2>
<p>Now you should be seeing the <code>pecan.xml</code> associated with
the choices you made above.</p>
<p>Remove <code>&lt;site&gt;</code>, <code>&lt;start.date&gt;</code> and
<code>&lt;end.date&gt;</code> tags from the <code>&lt;run&gt;</code>
section and add the <code>&lt;sitegroup&gt;</code> tag in your
<code>pecan.xml</code> before the <code>&lt;run&gt;</code> section for
the group of sites you are interested in. In this vignette, we will use
HB-PDA site group in BETYdb which consists of 12 temperate decidious
broadleaf forest (DBF) sites ofthe Ameriflux network.</p>
<p>Overall, your <code>pecan.xml</code> for these sections will look
like this:</p>
<pre><code>  &lt;sitegroup&gt;
    &lt;id&gt;1000000022&lt;/id&gt;
  &lt;/sitegroup&gt;
  &lt;run&gt;
    &lt;inputs&gt;
      &lt;met&gt;
        &lt;source&gt;AmerifluxLBL&lt;/source&gt;
        &lt;output&gt;SIPNET&lt;/output&gt;
      &lt;username&gt;pecan&lt;/username&gt;
      &lt;/met&gt;
    &lt;/inputs&gt;
  &lt;/run&gt;</code></pre>
<p>Now hit save button and open RStudio. Go to the working directory for
the run you just created. E.g.
<code>setwd("/fs/data2/output/PEcAn_1000010272")</code>.</p>
<p>Open <code>workflow.R</code> script and start going through the
lines. Stop after:</p>
<pre><code><span><span class="co"># Write pecan.CHECKED.xml</span></span>
<span><span class="fu">PEcAn.settings</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.settings/man/write.settings.html" class="external-link">write.settings</a></span><span class="op">(</span><span class="va">settings</span>, outputfile <span class="op">=</span> <span class="st">"pecan.CHECKED.xml"</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="fill-in-site-specific-input-information">Fill in site-specific input information<a class="anchor" aria-label="anchor" href="#fill-in-site-specific-input-information"></a>
</h2>
<p>When you open <code>pecan.CHECKED.xml</code>, you’ll see that the
<code>&lt;run&gt;</code> tag has expanded with the same tags repeated
for each site. Now specify <code>&lt;inputs&gt;</code>,
<code>&lt;start.date&gt;</code> and <code>&lt;end.date&gt;</code>
information. E.g.:</p>
<pre><code> &lt;run&gt;
  &lt;settings.1&gt;
   &lt;site&gt;
    &lt;id&gt;796&lt;/id&gt;
    &lt;met.start&gt;2005/01/01&lt;/met.start&gt;
    &lt;met.end&gt;2011/12/31&lt;/met.end&gt;
    &lt;name&gt;Bartlett Experimental Forest (US-Bar)&lt;/name&gt;
    &lt;lat&gt;44.06464&lt;/lat&gt;
    &lt;lon&gt;-71.288077&lt;/lon&gt;
   &lt;/site&gt;
   &lt;start.date&gt;2005/01/01&lt;/start.date&gt;
   &lt;end.date&gt;2011/12/31&lt;/end.date&gt;
   &lt;inputs&gt;
    &lt;met&gt;
     &lt;path&gt;
      &lt;path1&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_0-796/AMF_US-Bar_BASE_HH_4-1.2005-01-01.2011-12-31.clim&lt;/path1&gt;
     &lt;/path&gt;
    &lt;/met&gt;
    &lt;poolinitcond&gt;
     &lt;path&gt;/fs/data3/istfer/HPDA/data/param.files/site_0-796/IC_site_0-796.nc&lt;/path&gt;
    &lt;/poolinitcond&gt;
   &lt;/inputs&gt;
  &lt;/settings.1&gt;
  &lt;settings.2&gt;
   &lt;site&gt;
    &lt;id&gt;767&lt;/id&gt;
    &lt;met.start&gt;2001/01/01&lt;/met.start&gt;
    &lt;met.end&gt;2014/12/31&lt;/met.end&gt;
    &lt;name&gt;Morgan Monroe State Forest (US-MMS)&lt;/name&gt;
    &lt;lat&gt;39.3231&lt;/lat&gt;
    &lt;lon&gt;-86.4131&lt;/lon&gt;
   &lt;/site&gt;
   &lt;start.date&gt;2001/01/01&lt;/start.date&gt;
   &lt;end.date&gt;2014/12/31&lt;/end.date&gt;
   &lt;inputs&gt;
    &lt;met&gt;
     &lt;path&gt;
      &lt;path1&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_0-767/AMF_US-MMS_BASE_HR_8-1.2001-01-01.2014-12-31.clim&lt;/path1&gt;
     &lt;/path&gt;
    &lt;/met&gt;
    &lt;poolinitcond&gt;
     &lt;path&gt;/fs/data3/istfer/HPDA/data/param.files/site_0-767/IC_site_0-767.nc&lt;/path&gt;
    &lt;/poolinitcond&gt;
   &lt;/inputs&gt;
  &lt;/settings.2&gt;
  &lt;settings.3&gt;
   &lt;site&gt;
    &lt;id&gt;768&lt;/id&gt;
    &lt;met.start&gt;2005/01/01&lt;/met.start&gt;
    &lt;met.end&gt;2015/12/31&lt;/met.end&gt;
    &lt;name&gt;Missouri Ozark Site/BREA (US-MOz)&lt;/name&gt;
    &lt;lat&gt;38.7441&lt;/lat&gt;
    &lt;lon&gt;-92.2&lt;/lon&gt;
   &lt;/site&gt;
   &lt;start.date&gt;2005/01/01&lt;/start.date&gt;
   &lt;end.date&gt;2015/12/31&lt;/end.date&gt;
   &lt;inputs&gt;
    &lt;met&gt;
     &lt;path&gt;
      &lt;path1&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_0-768/AMF_US-MOz_BASE_HH_7-1.2005-01-01.2015-12-31.clim&lt;/path1&gt;
     &lt;/path&gt;
    &lt;/met&gt;
    &lt;poolinitcond&gt;
     &lt;path&gt;/fs/data3/istfer/HPDA/data/param.files/site_0-768/IC_site_0-768.nc&lt;/path&gt;
    &lt;/poolinitcond&gt;
   &lt;/inputs&gt;
  &lt;/settings.3&gt;
  &lt;settings.4&gt;
   &lt;site&gt;
    &lt;id&gt;776&lt;/id&gt;
    &lt;met.start&gt;2007/01/01&lt;/met.start&gt;
    &lt;met.end&gt;2014/12/31&lt;/met.end&gt;
    &lt;name&gt;Univiversity of Michigan Biological Station (US-UMB)&lt;/name&gt;
    &lt;lat&gt;45.5598&lt;/lat&gt;
    &lt;lon&gt;-84.7138&lt;/lon&gt;
   &lt;/site&gt;
   &lt;start.date&gt;2007/01/01&lt;/start.date&gt;
   &lt;end.date&gt;2014/12/31&lt;/end.date&gt;
   &lt;inputs&gt;
    &lt;met&gt;
     &lt;path&gt;
      &lt;path1&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_0-776/AMF_US-UMB_BASE_HH_10-1.2007-01-01.2014-12-31.clim&lt;/path1&gt;
     &lt;/path&gt;
    &lt;/met&gt;
    &lt;poolinitcond&gt;
     &lt;path&gt;/fs/data3/istfer/HPDA/data/param.files/site_0-776/IC_site_0-776.nc&lt;/path&gt;
    &lt;/poolinitcond&gt;
   &lt;/inputs&gt;
  &lt;/settings.4&gt;
  &lt;settings.5&gt;
   &lt;site&gt;
    &lt;id&gt;676&lt;/id&gt;
    &lt;met.start&gt;1999/01/01&lt;/met.start&gt;
    &lt;met.end&gt;2006/12/31&lt;/met.end&gt;
    &lt;name&gt;Willow Creek (US-WCr)&lt;/name&gt;
    &lt;lat&gt;45.805925&lt;/lat&gt;
    &lt;lon&gt;-90.07961&lt;/lon&gt;
   &lt;/site&gt;
   &lt;start.date&gt;1999/01/01&lt;/start.date&gt;
   &lt;end.date&gt;2006/12/31&lt;/end.date&gt;
   &lt;inputs&gt;
    &lt;met&gt;
     &lt;path&gt;
      &lt;path1&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_0-676/AMF_US-WCr_BASE_HH_11-1.1999-01-01.2006-12-31.clim&lt;/path1&gt;
     &lt;/path&gt;
    &lt;/met&gt;
    &lt;poolinitcond&gt;
     &lt;path&gt;/fs/data3/istfer/HPDA/data/param.files/site_0-676/IC_site_0-676.nc&lt;/path&gt;
    &lt;/poolinitcond&gt;
   &lt;/inputs&gt;
  &lt;/settings.5&gt;
  &lt;settings.6&gt;
   &lt;site&gt;
    &lt;id&gt;1000000109&lt;/id&gt;
    &lt;met.start&gt;2013/01/01&lt;/met.start&gt;
    &lt;met.end&gt;2015/12/31&lt;/met.end&gt;
    &lt;name&gt;Ontario - Turkey Point Mature Deciduous (CA-TPD)&lt;/name&gt;
    &lt;lat&gt;42.6353&lt;/lat&gt;
    &lt;lon&gt;-80.5577&lt;/lon&gt;
   &lt;/site&gt;
   &lt;start.date&gt;2013/01/01&lt;/start.date&gt;
   &lt;end.date&gt;2015/12/31&lt;/end.date&gt;
   &lt;inputs&gt;
    &lt;met&gt;
     &lt;path&gt;
      &lt;path1&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_1-109/AMF_CA-TPD_BASE_HH_1-1.2013-01-01.2015-12-31.clim&lt;/path1&gt;
     &lt;/path&gt;
    &lt;/met&gt;
    &lt;poolinitcond&gt;
     &lt;path&gt;/fs/data3/istfer/HPDA/data/param.files/site_1-109/IC_site_1-109.nc&lt;/path&gt;
    &lt;/poolinitcond&gt;
   &lt;/inputs&gt;
  &lt;/settings.6&gt;
  &lt;settings.7&gt;
   &lt;site&gt;
    &lt;id&gt;755&lt;/id&gt;
    &lt;met.start&gt;2002/01/01&lt;/met.start&gt;
    &lt;met.end&gt;2008/12/31&lt;/met.end&gt;
    &lt;name&gt;Duke Forest-hardwoods (US-Dk2)&lt;/name&gt;
    &lt;lat&gt;35.9736&lt;/lat&gt;
    &lt;lon&gt;-79.1004&lt;/lon&gt;
   &lt;/site&gt;
   &lt;start.date&gt;2002/01/01&lt;/start.date&gt;
   &lt;end.date&gt;2008/12/31&lt;/end.date&gt;
   &lt;inputs&gt;
    &lt;met&gt;
     &lt;path&gt;
      &lt;path1&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_0-755/AMF_US-Dk2_BASE_HH_4-4.2002-01-01.2008-12-31.clim&lt;/path1&gt;
     &lt;/path&gt;
    &lt;/met&gt;
    &lt;poolinitcond&gt;
     &lt;path&gt;/fs/data3/istfer/HPDA/data/param.files/site_0-755/IC_site_0-755.nc&lt;/path&gt;
    &lt;/poolinitcond&gt;
   &lt;/inputs&gt;
  &lt;/settings.7&gt;
  &lt;settings.8&gt;
   &lt;site&gt;
    &lt;id&gt;1000000145&lt;/id&gt;
    &lt;met.start&gt;2010/01/01&lt;/met.start&gt;
    &lt;met.end&gt;2010/12/31&lt;/met.end&gt;
    &lt;name&gt;Chestnut Ridge (US-ChR)&lt;/name&gt;
    &lt;lat&gt;35.9311&lt;/lat&gt;
    &lt;lon&gt;-84.3324&lt;/lon&gt;
   &lt;/site&gt;
   &lt;start.date&gt;2010/01/01&lt;/start.date&gt;
   &lt;end.date&gt;2010/12/31&lt;/end.date&gt;
   &lt;inputs&gt;
    &lt;met&gt;
     &lt;path&gt;
      &lt;path1&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_1-145//AMF_US-ChR_BASE_HH_2-1.2010-01-01.2010-12-31.clim&lt;/path1&gt;
     &lt;/path&gt;
    &lt;/met&gt;
    &lt;poolinitcond&gt;
     &lt;path&gt;/fs/data3/istfer/HPDA/data/param.files/site_1-145/IC_site_1-145.nc&lt;/path&gt;
    &lt;/poolinitcond&gt;
   &lt;/inputs&gt;
  &lt;/settings.8&gt;
  &lt;settings.9&gt;
   &lt;site&gt;
    &lt;id&gt;1000000066&lt;/id&gt;
    &lt;met.start&gt;2005/01/01&lt;/met.start&gt;
    &lt;met.end&gt;2014/12/31&lt;/met.end&gt;
    &lt;name&gt;Silas Little- New Jersey (US-Slt)&lt;/name&gt;
    &lt;lat&gt;39.9138&lt;/lat&gt;
    &lt;lon&gt;-74.596&lt;/lon&gt;
   &lt;/site&gt;
   &lt;start.date&gt;2005/01/01&lt;/start.date&gt;
   &lt;end.date&gt;2014/12/31&lt;/end.date&gt;
   &lt;inputs&gt;
    &lt;met&gt;
     &lt;path&gt;
      &lt;path1&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_1-66/AMF_US-Slt_BASE_HH_5-1.2005-01-01.2014-12-31.clim&lt;/path1&gt;
     &lt;/path&gt;
    &lt;/met&gt;
    &lt;poolinitcond&gt;
     &lt;path&gt;/fs/data3/istfer/HPDA/data/param.files/site_1-66/IC_site_1-66.nc&lt;/path&gt;
    &lt;/poolinitcond&gt;
   &lt;/inputs&gt;
  &lt;/settings.9&gt;
  &lt;settings.10&gt;
   &lt;site&gt;
    &lt;id&gt;1000000061&lt;/id&gt;
    &lt;met.start&gt;2004/01/01&lt;/met.start&gt;
    &lt;met.end&gt;2013/12/31&lt;/met.end&gt;
    &lt;name&gt;Oak Openings (US-Oho)&lt;/name&gt;
    &lt;lat&gt;41.5545&lt;/lat&gt;
    &lt;lon&gt;-83.8438&lt;/lon&gt;
   &lt;/site&gt;
   &lt;start.date&gt;2004/01/01&lt;/start.date&gt;
   &lt;end.date&gt;2013/12/31&lt;/end.date&gt;
   &lt;inputs&gt;
    &lt;met&gt;
     &lt;path&gt;
      &lt;path1&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_1-61/AMF_US-Oho_BASE_HH_4-1.2004-01-01.2013-12-31.clim&lt;/path1&gt;
     &lt;/path&gt;
    &lt;/met&gt;
    &lt;poolinitcond&gt;
     &lt;path&gt;/fs/data3/istfer/HPDA/data/param.files/site_1-61/IC_site_1-61.nc&lt;/path&gt;
    &lt;/poolinitcond&gt;
   &lt;/inputs&gt;
  &lt;/settings.10&gt;
  &lt;settings.11&gt;
   &lt;site&gt;
    &lt;id&gt;740&lt;/id&gt;
    &lt;met.start&gt;1997/01/01&lt;/met.start&gt;
    &lt;met.end&gt;2010/12/31&lt;/met.end&gt;
    &lt;name&gt;BOREAS SSA Old Aspen (CA-Oas)&lt;/name&gt;
    &lt;lat&gt;53.6289&lt;/lat&gt;
    &lt;lon&gt;-106.198&lt;/lon&gt;
   &lt;/site&gt;
   &lt;start.date&gt;1997/01/01&lt;/start.date&gt;
   &lt;end.date&gt;2010/12/31&lt;/end.date&gt;
   &lt;inputs&gt;
    &lt;met&gt;
     &lt;path&gt;
      &lt;path1&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_0-740/AMF_CA-Oas_BASE_HH_1-1.1997-01-01.2010-12-31.clim&lt;/path1&gt;
     &lt;/path&gt;
    &lt;/met&gt;
    &lt;poolinitcond&gt;
     &lt;path&gt;/fs/data3/istfer/HPDA/data/param.files/site_0-740/IC_site_0-740.nc&lt;/path&gt;
    &lt;/poolinitcond&gt;
   &lt;/inputs&gt;
  &lt;/settings.11&gt;
  &lt;settings.12&gt;
   &lt;site&gt;
    &lt;id&gt;758&lt;/id&gt;
    &lt;met.start&gt;2010/01/01&lt;/met.start&gt;
    &lt;met.end&gt;2015/12/31&lt;/met.end&gt;
    &lt;name&gt;Harvard Forest EMS Tower/HFR1 (US-Ha1)&lt;/name&gt;
    &lt;lat&gt;42.5378&lt;/lat&gt;
    &lt;lon&gt;-72.1715&lt;/lon&gt;
   &lt;/site&gt;
   &lt;start.date&gt;2010/01/01&lt;/start.date&gt;
   &lt;end.date&gt;2015/12/31&lt;/end.date&gt;
   &lt;inputs&gt;
    &lt;met&gt;
     &lt;path&gt;
      &lt;path1&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_0-758/AMF_US-Ha1_BASE_HR_10-1.2010-01-01.2015-12-31.clim&lt;/path1&gt;
     &lt;/path&gt;
    &lt;/met&gt;
    &lt;poolinitcond&gt;
     &lt;path&gt;/fs/data3/istfer/HPDA/data/param.files/site_0-758/IC_site_0-758.nc&lt;/path&gt;
    &lt;/poolinitcond&gt;
   &lt;/inputs&gt;
  &lt;/settings.12&gt;
 &lt;/run&gt;</code></pre>
</div>
<div class="section level2">
<h2 id="modify-ensemble-analysis-tags">Modify ensemble analysis tags<a class="anchor" aria-label="anchor" href="#modify-ensemble-analysis-tags"></a>
</h2>
<p>Now let’s specify the ensemble <code>&lt;size&gt;</code> and the
ensemble <code>&lt;variable&gt;</code> within the
<code>&lt;ensemble&gt;</code> tag. In the paper we give an ensemble of
runs with <code>250</code> members but you can try smaller
ensembles.</p>
<p>Overall, your <code>pecan.xml</code> for the
<code>&lt;ensemble&gt;</code> sections will look like this:</p>
<pre><code>  &lt;ensemble&gt;
    &lt;size&gt;250&lt;/size&gt;
    &lt;variable&gt;NEE&lt;/variable&gt;
    &lt;samplingspace&gt;
     &lt;parameters&gt;
      &lt;method&gt;uniform&lt;/method&gt;
     &lt;/parameters&gt;
     &lt;met&gt;
     &lt;method&gt;sampling&lt;/method&gt;
     &lt;/met&gt;
   &lt;/samplingspace&gt;
  &lt;/ensemble&gt;</code></pre>
<p>Now save the file. Re-read the updated
<code>pecan.CHECKED.xml</code>, make sure to re-assign random effects as
logical, otherwise <code>meta.analysis</code> will throw an error:</p>
<pre><code><span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu">read.settings</span><span class="op">(</span><span class="st">"pecan.CHECKED.xml"</span><span class="op">)</span></span>
<span><span class="va">settings</span><span class="op">$</span><span class="va">meta.analysis</span><span class="op">$</span><span class="va">random.effects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">meta.analysis</span><span class="op">$</span><span class="va">random.effects</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="global-sa">Global SA<a class="anchor" aria-label="anchor" href="#global-sa"></a>
</h2>
<pre><code><span><span class="va">globalSA_explore</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">workflow_dir</span>, <span class="va">var</span>, <span class="va">ens.settings</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">workflow_dir</span>, <span class="st">"/ensemble.samples."</span>, <span class="va">ens.settings</span><span class="op">$</span><span class="va">ensemble</span><span class="op">$</span><span class="va">ensemble.id</span>,<span class="st">".Rdata"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">samps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"cbind"</span>, <span class="va">ens.samples</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">workflow_dir</span>, <span class="st">"/ensemble.output."</span>, <span class="va">ens.settings</span><span class="op">$</span><span class="va">ensemble</span><span class="op">$</span><span class="va">ensemble.id</span>,</span>
<span>              <span class="st">"."</span>,<span class="va">var</span>,<span class="st">"."</span>, <span class="va">ens.settings</span><span class="op">$</span><span class="va">ensemble</span><span class="op">$</span><span class="va">start.year</span>, <span class="st">"."</span>,</span>
<span>              <span class="va">ens.settings</span><span class="op">$</span><span class="va">ensemble</span><span class="op">$</span><span class="va">end.year</span>,<span class="st">".Rdata"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">allm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">ensemble.output</span><span class="op">)</span>, <span class="va">samps</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">allm</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">var</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">samps</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">var</span>, <span class="st">" ~ ."</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">var.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">form</span>, <span class="va">allm</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">alls</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">var.fit</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>  </span>
<span>  <span class="va">alls</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">var.fit</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">&gt;=</span> <span class="fl">0.05</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>  <span class="co"># don't consider non-significant fits</span></span>
<span>  </span>
<span>  <span class="va">alls</span> <span class="op">&lt;-</span> <span class="va">alls</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">alls</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"(Intercept)"</span><span class="op">]</span></span>
<span>  <span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">alls</span><span class="op">)</span> </span>
<span>  </span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">preds</span><span class="op">)</span></span>
<span>  <span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="fu"><a href="https://rdrr.io/r/utils/combn.html" class="external-link">combn</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>,<span class="va">i</span>,simplify<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>,recursive<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">Formulas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">id</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">var</span>,<span class="st">"~"</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">preds</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,collapse<span class="op">=</span><span class="st">":"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">Formulas</span>,<span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>, data<span class="op">=</span><span class="va">allm</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">tr</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">f</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fits</span><span class="op">[[</span><span class="va">tr</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">fstatistic</span></span>
<span>    <span class="va">pfval</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Fdist.html" class="external-link">pf</a></span><span class="op">(</span><span class="va">f</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">f</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,<span class="va">f</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,lower.tail<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">pfval</span> <span class="op">&lt;</span> <span class="fl">0.001</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">alls</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">alls</span><span class="op">)</span> <span class="op">==</span> <span class="va">preds</span><span class="op">[</span><span class="va">tr</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fits</span><span class="op">[[</span><span class="va">tr</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span></span>
<span>    <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>      <span class="va">alls</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">alls</span><span class="op">)</span> <span class="op">==</span> <span class="va">preds</span><span class="op">[</span><span class="va">tr</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">alls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">alls</span><span class="op">)</span>, rexp <span class="op">=</span> <span class="va">alls</span>, site <span class="op">=</span><span class="va">i</span><span class="op">)</span></span>
<span>  <span class="va">alls</span> <span class="op">&lt;-</span> <span class="va">alls</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span> <span class="va">alls</span><span class="op">$</span><span class="va">rexp</span><span class="op">)</span>,<span class="op">]</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">alls</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">workflow_dir</span> <span class="op">&lt;-</span> <span class="st">"/fs/data2/output//PEcAn_1000010172"</span></span>
<span></span>
<span><span class="va">multi.settings</span> <span class="op">&lt;-</span> <span class="fu">read.settings</span><span class="op">(</span><span class="st">"pecan.CONFIGS.xml"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Qle_list</span> <span class="op">&lt;-</span> <span class="va">NEE_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">multi.settings</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">Qle_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">globalSA_explore</span><span class="op">(</span><span class="va">workflow_dir</span>, <span class="st">"Qle"</span>, <span class="va">multi.settings</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">NEE_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">globalSA_explore</span><span class="op">(</span><span class="va">workflow_dir</span>, <span class="st">"NEE"</span>, <span class="va">multi.settings</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span> </span>
<span><span class="va">Qle_df</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">Qle_list</span><span class="op">)</span></span>
<span><span class="va">Qle_df</span><span class="op">$</span><span class="va">var</span> <span class="op">&lt;-</span> <span class="st">"Qle"</span></span>
<span><span class="va">NEE_df</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">NEE_list</span><span class="op">)</span></span>
<span><span class="va">NEE_df</span><span class="op">$</span><span class="va">var</span> <span class="op">&lt;-</span> <span class="st">"NEE"</span></span>
<span><span class="va">allm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">Qle_df</span>, <span class="va">NEE_df</span><span class="op">)</span></span>
<span><span class="va">allm</span> <span class="op">&lt;-</span> <span class="va">allm</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">allm</span><span class="op">$</span><span class="va">rexp</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">allm</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">par</span>, <span class="va">rexp</span>, fill<span class="op">=</span><span class="va">var</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">coord_flip</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ylab</span><span class="op">(</span><span class="st">"R2"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">xlab</span><span class="op">(</span><span class="st">"SIPNET parameters"</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="fu">geom_boxplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span>
<span></span></code></pre>
<p>Then continue with the rest of the workflow until
<code>&lt;assim.batch&gt;</code> module:</p>
<pre><code><span><span class="co"># Run parameter data assimilation</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="st">'assim.batch'</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">settings</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.check</a></span><span class="op">(</span><span class="st">"PDA"</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.start</a></span><span class="op">(</span><span class="st">"PDA"</span><span class="op">)</span></span>
<span>    <span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu">PEcAn.assim.batch</span><span class="fu">::</span><span class="fu"><a href="../reference/runModule.assim.batch.html">runModule.assim.batch</a></span><span class="op">(</span><span class="va">settings</span><span class="op">)</span></span>
<span>    <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.end</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre>
<p>Before running this module, we will conduct some analyses on the
ensemble run outputs to identify the parameters we would like to target
in PDA.</p>
<p>add the PDA tags, see next section.</p>
</div>
<div class="section level2">
<h2 id="settings-for-hb-pda">Settings for HB-PDA<a class="anchor" aria-label="anchor" href="#settings-for-hb-pda"></a>
</h2>
<p>Similar to PDA settings, we will contain HB-PDA settings under the
<code>&lt;assim.batch&gt;</code> section. Likewise standard PDA, if you
have chosen the parameters you want to target in the calibration, we
will open the <code>pecan.CONFIGS.xml</code> file, and insert the
<code>&lt;assim.batch&gt;</code> tag.</p>
<p>Different from the PDA settings, this time the main function will be
the <code>emulator.ms</code>. This function can be run in three modes,
which will be selected under the <code>&lt;mode&gt;</code> tag above:
individual, joint and hierarchical. If left empty, the function will go
through all three modes. But note that, for both joint and hierarhical
calibration, we need site-level runs. We will start with individual
mode, i.e. site-level calibration.</p>
<p>Now open the <code>pecan.CONFIGS.xml</code> file. First, add
<code>&lt;assim.batch&gt;</code> tag to the multisettings in the bottom
of your xml among others:</p>
<pre><code> &lt;multisettings&gt;
  &lt;multisettings&gt;assim.batch&lt;/multisettings&gt;
  &lt;multisettings&gt;ensemble&lt;/multisettings&gt;
  &lt;multisettings&gt;sensitivity.analysis&lt;/multisettings&gt;
  &lt;multisettings&gt;run&lt;/multisettings&gt;
 &lt;/multisettings&gt;</code></pre>
<p>Now we can insert multi-site settings in the
<code>&lt;assim.batch&gt;</code> section accordingly (note that
<code>method</code>, <code>mode</code>, <code>param.names</code> etc.
will go under each <code>setting.*</code>):</p>
<pre><code> &lt;assim.batch&gt;
  &lt;settings.1&gt;
    &lt;method&gt;emulator.ms&lt;/method&gt;
    &lt;mode&gt;individual&lt;/mode&gt;
    &lt;n.knot&gt;70&lt;/n.knot&gt;
    &lt;iter&gt;100000&lt;/iter&gt;
    &lt;chain&gt;3&lt;/chain&gt;
    &lt;param.names&gt;
     &lt;soil.IF&gt;
      &lt;param&gt;som_respiration_rate&lt;/param&gt;
      &lt;param&gt;soil_respiration_Q10&lt;/param&gt;
     &lt;/soil.IF&gt;
     &lt;temperate.deciduous.IF&gt;
      &lt;param&gt;psnTOpt&lt;/param&gt;
      &lt;param&gt;half_saturation_PAR&lt;/param&gt;
      &lt;param&gt;dVPDSlope&lt;/param&gt;
      &lt;param&gt;leafGrowth&lt;/param&gt;
      &lt;param&gt;AmaxFrac&lt;/param&gt;
     &lt;/temperate.deciduous.IF&gt;
    &lt;/param.names&gt;
    &lt;inputs&gt;
      &lt;file&gt;
        &lt;input.id&gt;1000013322&lt;/input.id&gt;
        &lt;path&gt;
         &lt;path&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_0-796/AMF_US-Bar_BASE_HH_4-1.csv&lt;/path&gt;
        &lt;/path&gt;
        &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
        &lt;variable.id&gt;1000000042&lt;/variable.id&gt;
        &lt;variable.name&gt;
          &lt;variable.name&gt;FC&lt;/variable.name&gt;
          &lt;variable.name&gt;UST&lt;/variable.name&gt;
       &lt;/variable.name&gt;
     &lt;/file&gt;
    &lt;/inputs&gt;
  &lt;/settings.1&gt;
  &lt;settings.2&gt;
    &lt;method&gt;emulator.ms&lt;/method&gt;
    &lt;mode&gt;individual&lt;/mode&gt;
    &lt;n.knot&gt;70&lt;/n.knot&gt;
    &lt;iter&gt;100000&lt;/iter&gt;
    &lt;chain&gt;3&lt;/chain&gt;
    &lt;param.names&gt;
     &lt;soil.IF&gt;
      &lt;param&gt;som_respiration_rate&lt;/param&gt;
      &lt;param&gt;soil_respiration_Q10&lt;/param&gt;
     &lt;/soil.IF&gt;
     &lt;temperate.deciduous.IF&gt;
      &lt;param&gt;psnTOpt&lt;/param&gt;
      &lt;param&gt;half_saturation_PAR&lt;/param&gt;
      &lt;param&gt;dVPDSlope&lt;/param&gt;
      &lt;param&gt;leafGrowth&lt;/param&gt;
      &lt;param&gt;AmaxFrac&lt;/param&gt;
     &lt;/temperate.deciduous.IF&gt;
    &lt;/param.names&gt;
    &lt;inputs&gt;
      &lt;file&gt;
        &lt;input.id&gt;1000013317&lt;/input.id&gt;
        &lt;path&gt;
         &lt;path&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_0-767/AMF_US-MMS_BASE_HR_8-1.csv&lt;/path&gt;
        &lt;/path&gt;
        &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
        &lt;variable.id&gt;1000000042&lt;/variable.id&gt;
        &lt;variable.name&gt;
          &lt;variable.name&gt;FC&lt;/variable.name&gt;
          &lt;variable.name&gt;UST&lt;/variable.name&gt;
       &lt;/variable.name&gt;
     &lt;/file&gt;
    &lt;/inputs&gt;
  &lt;/settings.2&gt;
  &lt;settings.3&gt;
    &lt;method&gt;emulator.ms&lt;/method&gt;
    &lt;mode&gt;individual&lt;/mode&gt;
    &lt;n.knot&gt;70&lt;/n.knot&gt;
    &lt;iter&gt;100000&lt;/iter&gt;
    &lt;chain&gt;3&lt;/chain&gt;
    &lt;param.names&gt;
     &lt;soil.IF&gt;
      &lt;param&gt;som_respiration_rate&lt;/param&gt;
      &lt;param&gt;soil_respiration_Q10&lt;/param&gt;
     &lt;/soil.IF&gt;
     &lt;temperate.deciduous.IF&gt;
      &lt;param&gt;psnTOpt&lt;/param&gt;
      &lt;param&gt;half_saturation_PAR&lt;/param&gt;
      &lt;param&gt;dVPDSlope&lt;/param&gt;
      &lt;param&gt;leafGrowth&lt;/param&gt;
      &lt;param&gt;AmaxFrac&lt;/param&gt;
     &lt;/temperate.deciduous.IF&gt;
    &lt;/param.names&gt;
    &lt;inputs&gt;
      &lt;file&gt;
        &lt;input.id&gt;1000013316&lt;/input.id&gt;
        &lt;path&gt;
         &lt;path&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_0-768/AMF_US-MOz_BASE_HH_7-1.csv&lt;/path&gt;
        &lt;/path&gt;
        &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
        &lt;variable.id&gt;1000000042&lt;/variable.id&gt;
        &lt;variable.name&gt;
          &lt;variable.name&gt;FC&lt;/variable.name&gt;
          &lt;variable.name&gt;UST&lt;/variable.name&gt;
       &lt;/variable.name&gt;
     &lt;/file&gt;
    &lt;/inputs&gt;
  &lt;/settings.3&gt;
  &lt;settings.4&gt;
    &lt;method&gt;emulator.ms&lt;/method&gt;
    &lt;mode&gt;individual&lt;/mode&gt;
    &lt;n.knot&gt;70&lt;/n.knot&gt;
    &lt;iter&gt;100000&lt;/iter&gt;
    &lt;chain&gt;3&lt;/chain&gt;
    &lt;param.names&gt;
     &lt;soil.IF&gt;
      &lt;param&gt;som_respiration_rate&lt;/param&gt;
      &lt;param&gt;soil_respiration_Q10&lt;/param&gt;
     &lt;/soil.IF&gt;
     &lt;temperate.deciduous.IF&gt;
      &lt;param&gt;psnTOpt&lt;/param&gt;
      &lt;param&gt;half_saturation_PAR&lt;/param&gt;
      &lt;param&gt;dVPDSlope&lt;/param&gt;
      &lt;param&gt;leafGrowth&lt;/param&gt;
      &lt;param&gt;AmaxFrac&lt;/param&gt;
     &lt;/temperate.deciduous.IF&gt;
    &lt;/param.names&gt;
    &lt;inputs&gt;
      &lt;file&gt;
        &lt;input.id&gt;1000013832&lt;/input.id&gt;
        &lt;path&gt;
         &lt;path&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_0-776/AMF_US-UMB_BASE_HH_10-1.csv&lt;/path&gt;
        &lt;/path&gt;
        &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
        &lt;variable.id&gt;1000000042&lt;/variable.id&gt;
        &lt;variable.name&gt;
          &lt;variable.name&gt;FC&lt;/variable.name&gt;
          &lt;variable.name&gt;UST&lt;/variable.name&gt;
       &lt;/variable.name&gt;
     &lt;/file&gt;
    &lt;/inputs&gt;
  &lt;/settings.4&gt;
  &lt;settings.5&gt;
    &lt;method&gt;emulator.ms&lt;/method&gt;
    &lt;mode&gt;individual&lt;/mode&gt;
    &lt;n.knot&gt;70&lt;/n.knot&gt;
    &lt;iter&gt;100000&lt;/iter&gt;
    &lt;chain&gt;3&lt;/chain&gt;
    &lt;param.names&gt;
     &lt;soil.IF&gt;
      &lt;param&gt;som_respiration_rate&lt;/param&gt;
      &lt;param&gt;soil_respiration_Q10&lt;/param&gt;
     &lt;/soil.IF&gt;
     &lt;temperate.deciduous.IF&gt;
      &lt;param&gt;psnTOpt&lt;/param&gt;
      &lt;param&gt;half_saturation_PAR&lt;/param&gt;
      &lt;param&gt;dVPDSlope&lt;/param&gt;
      &lt;param&gt;leafGrowth&lt;/param&gt;
      &lt;param&gt;AmaxFrac&lt;/param&gt;
     &lt;/temperate.deciduous.IF&gt;
    &lt;/param.names&gt;
    &lt;inputs&gt;
      &lt;file&gt;
        &lt;input.id&gt;1000012965&lt;/input.id&gt;
        &lt;path&gt;
         &lt;path&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_0-676/AMF_US-WCr_BASE_HH_11-1.csv&lt;/path&gt;
        &lt;/path&gt;
        &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
        &lt;variable.id&gt;1000000042&lt;/variable.id&gt;
        &lt;variable.name&gt;
          &lt;variable.name&gt;FC&lt;/variable.name&gt;
          &lt;variable.name&gt;UST&lt;/variable.name&gt;
       &lt;/variable.name&gt;
     &lt;/file&gt;
    &lt;/inputs&gt;
  &lt;/settings.5&gt;
  &lt;settings.6&gt;
    &lt;method&gt;emulator.ms&lt;/method&gt;
    &lt;mode&gt;individual&lt;/mode&gt;
    &lt;n.knot&gt;70&lt;/n.knot&gt;
    &lt;iter&gt;100000&lt;/iter&gt;
    &lt;chain&gt;3&lt;/chain&gt;
    &lt;param.names&gt;
     &lt;soil.IF&gt;
      &lt;param&gt;som_respiration_rate&lt;/param&gt;
      &lt;param&gt;soil_respiration_Q10&lt;/param&gt;
     &lt;/soil.IF&gt;
     &lt;temperate.deciduous.IF&gt;
      &lt;param&gt;psnTOpt&lt;/param&gt;
      &lt;param&gt;half_saturation_PAR&lt;/param&gt;
      &lt;param&gt;dVPDSlope&lt;/param&gt;
      &lt;param&gt;leafGrowth&lt;/param&gt;
      &lt;param&gt;AmaxFrac&lt;/param&gt;
     &lt;/temperate.deciduous.IF&gt;
    &lt;/param.names&gt;
    &lt;inputs&gt;
      &lt;file&gt;
        &lt;input.id&gt;1000013836&lt;/input.id&gt;
        &lt;path&gt;
         &lt;path&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_1-109/AMF_CA-TPD_BASE_HH_1-1.csv&lt;/path&gt;
        &lt;/path&gt;
        &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
        &lt;variable.id&gt;1000000042&lt;/variable.id&gt;
        &lt;variable.name&gt;
          &lt;variable.name&gt;FC&lt;/variable.name&gt;
          &lt;variable.name&gt;UST&lt;/variable.name&gt;
       &lt;/variable.name&gt;
     &lt;/file&gt;
    &lt;/inputs&gt;
  &lt;/settings.6&gt;
  &lt;settings.7&gt;
    &lt;method&gt;emulator.ms&lt;/method&gt;
    &lt;mode&gt;individual&lt;/mode&gt;
    &lt;n.knot&gt;70&lt;/n.knot&gt;
    &lt;iter&gt;100000&lt;/iter&gt;
    &lt;chain&gt;3&lt;/chain&gt;
    &lt;param.names&gt;
     &lt;soil.IF&gt;
      &lt;param&gt;som_respiration_rate&lt;/param&gt;
      &lt;param&gt;soil_respiration_Q10&lt;/param&gt;
     &lt;/soil.IF&gt;
     &lt;temperate.deciduous.IF&gt;
      &lt;param&gt;psnTOpt&lt;/param&gt;
      &lt;param&gt;half_saturation_PAR&lt;/param&gt;
      &lt;param&gt;dVPDSlope&lt;/param&gt;
      &lt;param&gt;leafGrowth&lt;/param&gt;
      &lt;param&gt;AmaxFrac&lt;/param&gt;
     &lt;/temperate.deciduous.IF&gt;
    &lt;/param.names&gt;
    &lt;inputs&gt;
      &lt;file&gt;
        &lt;input.id&gt;1000013546&lt;/input.id&gt;
        &lt;path&gt;
         &lt;path&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_1-145/AMF_US-ChR_BASE_HH_2-1.csv&lt;/path&gt;
        &lt;/path&gt;
        &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
        &lt;variable.id&gt;1000000042&lt;/variable.id&gt;
        &lt;variable.name&gt;
          &lt;variable.name&gt;FC&lt;/variable.name&gt;
          &lt;variable.name&gt;UST&lt;/variable.name&gt;
       &lt;/variable.name&gt;
     &lt;/file&gt;
    &lt;/inputs&gt;
  &lt;/settings.7&gt;
  &lt;settings.8&gt;
    &lt;method&gt;emulator.ms&lt;/method&gt;
    &lt;mode&gt;individual&lt;/mode&gt;
    &lt;n.knot&gt;70&lt;/n.knot&gt;
    &lt;iter&gt;100000&lt;/iter&gt;
    &lt;chain&gt;3&lt;/chain&gt;
    &lt;param.names&gt;
     &lt;soil.IF&gt;
      &lt;param&gt;som_respiration_rate&lt;/param&gt;
      &lt;param&gt;soil_respiration_Q10&lt;/param&gt;
     &lt;/soil.IF&gt;
     &lt;temperate.deciduous.IF&gt;
      &lt;param&gt;psnTOpt&lt;/param&gt;
      &lt;param&gt;half_saturation_PAR&lt;/param&gt;
      &lt;param&gt;dVPDSlope&lt;/param&gt;
      &lt;param&gt;leafGrowth&lt;/param&gt;
      &lt;param&gt;AmaxFrac&lt;/param&gt;
     &lt;/temperate.deciduous.IF&gt;
    &lt;/param.names&gt;
    &lt;inputs&gt;
      &lt;file&gt;
        &lt;input.id&gt;1000013572&lt;/input.id&gt;
        &lt;path&gt;
         &lt;path&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_1-66/AMF_US-Slt_BASE_HH_5-1.csv&lt;/path&gt;
        &lt;/path&gt;
        &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
        &lt;variable.id&gt;1000000042&lt;/variable.id&gt;
        &lt;variable.name&gt;
          &lt;variable.name&gt;FC&lt;/variable.name&gt;
          &lt;variable.name&gt;UST&lt;/variable.name&gt;
       &lt;/variable.name&gt;
     &lt;/file&gt;
    &lt;/inputs&gt;
  &lt;/settings.8&gt;
    &lt;settings.9&gt;
    &lt;method&gt;emulator.ms&lt;/method&gt;
    &lt;mode&gt;individual&lt;/mode&gt;
    &lt;n.knot&gt;70&lt;/n.knot&gt;
    &lt;iter&gt;100000&lt;/iter&gt;
    &lt;chain&gt;3&lt;/chain&gt;
    &lt;param.names&gt;
     &lt;soil.IF&gt;
      &lt;param&gt;som_respiration_rate&lt;/param&gt;
      &lt;param&gt;soil_respiration_Q10&lt;/param&gt;
     &lt;/soil.IF&gt;
     &lt;temperate.deciduous.IF&gt;
      &lt;param&gt;psnTOpt&lt;/param&gt;
      &lt;param&gt;half_saturation_PAR&lt;/param&gt;
      &lt;param&gt;dVPDSlope&lt;/param&gt;
      &lt;param&gt;leafGrowth&lt;/param&gt;
      &lt;param&gt;AmaxFrac&lt;/param&gt;
     &lt;/temperate.deciduous.IF&gt;
    &lt;/param.names&gt;
    &lt;inputs&gt;
      &lt;file&gt;
        &lt;input.id&gt;1000013482&lt;/input.id&gt;
        &lt;path&gt;
         &lt;path&gt;/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_1-61/AMF_US-Oho_BASE_HH_4-1.csv&lt;/path&gt;
        &lt;/path&gt;
        &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
        &lt;variable.id&gt;1000000042&lt;/variable.id&gt;
        &lt;variable.name&gt;
          &lt;variable.name&gt;FC&lt;/variable.name&gt;
          &lt;variable.name&gt;UST&lt;/variable.name&gt;
       &lt;/variable.name&gt;
     &lt;/file&gt;
    &lt;/inputs&gt;
  &lt;/settings.9&gt;
  &lt;/assim.batch&gt;</code></pre>
<p>Now save this as <code>pecan.HBPDA.xml</code> and read it.</p>
<p>Following section briefly explains what happens after:</p>
<pre><code><span><span class="va">multi.settings</span> <span class="op">&lt;-</span> <span class="fu">read.settings</span><span class="op">(</span><span class="st">"pecan.HBPDA.xml"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/pda.emulator.ms.html">pda.emulator.ms</a></span><span class="op">(</span><span class="va">multi.settings</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="the-workflow-for-hb-pda">The workflow for HB-PDA<a class="anchor" aria-label="anchor" href="#the-workflow-for-hb-pda"></a>
</h2>
<p>HB-PDA workflow for multiple sites starts with fitting models
locally. This is done by looping over the PEcAn multi-settings list
using the <code>pda.emulator</code> function. During this step,
site-level runs, GP fitting and MCMC are done. Components of these runs
are saved and will be used in global and hierarhical fitting.</p>
<p>In global calibration, we estimate posterior using all site-level GPs
at once at each iteration. Proposed values are plugged-in all GPs, and
accepted/rejected according to all estimated likelihoods.</p>
<p>Hierarhical calibration, uses a similar function to
<code>mcmc.GP</code> but modified for hierarchihcal fitting, called
<code>hier.mcmc</code>. Within this function, both site-level and
(hierarchically modeled) global parameters are fitted.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mike Dietze, Istem Fer, Ryan Kelly.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
