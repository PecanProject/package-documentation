<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>PEcAn.assim.batch Vignette • PEcAn.assim.batch</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="PEcAn.assim.batch Vignette">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">PEcAn.assim.batch</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.9.0</small>

    <a href="../index.html" style="padding: 0em 1em">← Up</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/AssimBatchVignette.html">PEcAn.assim.batch Vignette</a></li>
    <li><a class="dropdown-item" href="../articles/MultiSitePDAVignette.html">Multi-site hierarchical calibration vignette</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>PEcAn.assim.batch Vignette</h1>
                        <h4 data-toc-skip class="author">Istem Fer</h4>
                        <h4 data-toc-skip class="author">Ryan Kelly</h4>
            
            <h4 data-toc-skip class="date">January 5, 2022</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/PecanProject/pecan/blob/develop/modules/assim.batch/vignettes/AssimBatchVignette.Rmd" class="external-link"><code>vignettes/AssimBatchVignette.Rmd</code></a></small>
      <div class="d-none name"><code>AssimBatchVignette.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="install-package-from-github">Install package from Github<a class="anchor" aria-label="anchor" href="#install-package-from-github"></a>
</h2>
<p>Only needs to be done the first time :</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/" class="external-link">devtools</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"PecanProject/pecan"</span>, subdir<span class="op">=</span><span class="st">"all"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="parameter-data-assimilation-a-k-a--calibration-in-pecan">Parameter Data Assimilation (a.k.a. calibration) in PEcAn<a class="anchor" aria-label="anchor" href="#parameter-data-assimilation-a-k-a--calibration-in-pecan"></a>
</h2>
<p>Currently, there are three ways of doing Parameter Data Assimilation
(PDA) in PEcAn :</p>
<ul>
<li>bayesian.tools (bruteforce algorithms)</li>
<li>emulator</li>
<li>multi-site hierarchical PDA (HPDA) with emulators</li>
</ul>
<p><strong>Note that, there used to be Metropolis-Hastings Markov Chain
Monte Carlo (MCMC) algorithms implemented natively in PEcAn, namely
<code>/modules/assim.batch/R/pda.mcmc.R</code> and
<code>pda.mcmc.bs.R</code>. These are deprecated and they will no longer
be maintained.</strong></p>
<div class="section level3">
<h3 id="which-one-to-use">Which one to use?<a class="anchor" aria-label="anchor" href="#which-one-to-use"></a>
</h3>
<p><strong>bayesian.tools :</strong> The
<code>pda.bayesian.tools.R</code> is the main script of this PDA
workflow that performs a bruteforce (MCMC methods that require running
your models at least couple of thousand of times) calibration. This
script uses the <code>BayesianTools</code> R-package (Hartig, Minuno and
Paul, 2019) that includes MCMC and SMC samplers and other tools for
Bayesian parameter calibration with external models. If you choose
<em>bayesian.tools</em> option, PEcAn framework will hand the PDA
calculations over to the <code>BayesianTools</code> package. Although
this package includes algorithms that are designed to explore the
parameter space more efficiently than the traditional MH-MCMC, you would
still need a relatively faster model to use these algorithms. Note that
the <code>BayesianTools</code> R-package itself is constantly under
development, and its integration with PEcAn may not be able to leverage
all <code>BayesianTools</code> functionality.</p>
<p><strong>emulator :</strong> The <code>pda.emulator.R</code> is the
main script of this PDA workflow. When a model is slow, it is
practically not possible to run it hundreds of thousands of times
sequentially to explore the parameter space and draw enough samples to
converge the target distribution with bruteforce algorithms. Instead, we
can run the model for a relatively smaller number of times with
parameter combinations that have been carefully chosen to give good
coverage of parameter space. Then we can interpolate the likelihood
calculated for each of those runs to get a surface that “emulates” the
true likelihood and perform regular MCMC (just like the “bruteforce”
approach), except instead of actually running the model on every
iteration to obtain a likelihood value, this time we will just get an
approximation from the likelihood emulator. A lot more details about the
emulator approach can be found in <a href="https://doi.org/10.5194/bg-15-5801-2018" class="external-link">Fer et al. 2018.</a></p>
<p><strong>Multi-site HPDA :</strong> The <code>pda.emulator.ms.R</code>
is the main script of this PDA workflow which performs a multi-site
hierarchical Bayesian calibration using the emulator approach. In the
multi-site hierarhical calibration, global posteriors are fitted
simultaneously using an additional Gibbs update step, and used as the
new prior hyperparameters in the next iteration of MCMC to obtain
site-level hierarchical posteriors. This PDA workflow has its own
vignette (see
<code>/modules/assim.batch/vignettes/MultiSitePDAVignette.Rmd</code>)
and will not be one of the examples here. For more information also see
<a href="https://doi.org/10.1101/2021.04.28.441243" class="external-link">Fer et al. 2021
bioRxiv preprint</a>.</p>
</div>
</div>
<div class="section level2">
<h2 id="adding-pda-tags-to-pecan-xml">Adding PDA tags to pecan.xml<a class="anchor" aria-label="anchor" href="#adding-pda-tags-to-pecan-xml"></a>
</h2>
<p>The easiest way to use PEcAn’s parameter data assimilation module is
to add an <code>&lt;assim.batch&gt;</code> block to pecan.xml, load the
file with <code>read.settings</code>, and pass the resulting settings
object to <code><a href="../reference/pda.bayesian.tools.html">pda.bayesian.tools()</a></code> or
<code><a href="../reference/pda.emulator.html">pda.emulator()</a></code>. There are some differences in the settings
for using different PDA methods (we will go through test cases, at this
point just familiarize yourself with the general pattern), but here is
an example <code>&lt;assim.batch&gt;</code> block :</p>
<pre><code>&lt;assim.batch&gt;
  &lt;iter&gt;100000&lt;/iter&gt;
  &lt;method&gt;emulator&lt;/method&gt;                     &lt;--- WHICH PDA APPROACH
  &lt;chain&gt;3&lt;/chain&gt;
  &lt;param.names&gt;
   &lt;temperate.coniferous&gt;                       &lt;--- YOUR PFT(S)
    &lt;param&gt;PARAM1&lt;/param&gt;                       &lt;--- PARAMETER(S) YOU TARGET IN PDA
    &lt;param&gt;PARAM2&lt;/param&gt;
   &lt;/temperate.coniferous&gt;
  &lt;/param.names&gt;
  &lt;jump&gt;
   &lt;adapt&gt;250&lt;/adapt&gt;
   &lt;adj.min&gt;0.1&lt;/adj.min&gt;
   &lt;ar.target&gt;0.3&lt;/ar.target&gt;
  &lt;/jump&gt;
  &lt;inputs&gt;
    &lt;file&gt;
      &lt;input.id&gt; ... &lt;/input.id&gt;               &lt;--- YOUR CONSTRAINT ID FROM BETY DB 
      &lt;path&gt;
        &lt;path&gt; ... &lt;/path&gt;                     &lt;--- YOUR CONSTRAINT FILE PATH(S)
        &lt;path&gt; ... &lt;/path&gt;
      &lt;/path&gt;
      &lt;likelihood&gt;Laplace&lt;/likelihood&gt;         &lt;--- LIKELIHOOD FORM FOR THIS CONSTRAINT 
      &lt;variable.id&gt;298&lt;/variable.id&gt;           &lt;--- (CONSTRAINT) VARIABLE ID FROM BETY DB
      &lt;variable.name&gt;
        &lt;variable.name&gt;LE&lt;/variable.name&gt;      &lt;--- (CONSTRAINT) VARIABLE
        &lt;variable.name&gt;UST&lt;/variable.name&gt;     &lt;--- HELPER VARIABLE SPECIFIC TO FLUX CASE
      &lt;/variable.name&gt;
    &lt;/file&gt;
    &lt;file&gt;
      &lt;input.id&gt;...&lt;/input.id&gt;
      &lt;path&gt;
        &lt;path&gt;...&lt;/path&gt;
      &lt;/path&gt;
      &lt;likelihood&gt;multipGauss&lt;/likelihood&gt;
      &lt;hyper.pars&gt;
        &lt;parama&gt;0.001&lt;/parama&gt;                 &lt;--- HYPERPARAMETERS SPECIFIC TO GAUSSIAN FORM
        &lt;paramb&gt;0.001&lt;/paramb&gt;
      &lt;/hyper.pars&gt;
      &lt;ss.positive&gt;TRUE&lt;/ss.positive&gt;
      &lt;variable.id&gt;...&lt;/variable.id&gt; 
      &lt;variable.name&gt;
        &lt;variable.name&gt;...&lt;/variable.name&gt;
      &lt;/variable.name&gt;
    &lt;/file&gt;
  &lt;/inputs&gt;
&lt;/assim.batch&gt;</code></pre>
<p>Here are some more details about the PDA tags:</p>
<ul>
<li><p><code>&lt;iter&gt;</code> Specifies the number of MCMC iterations
to run. If continuing a previous MCMC, this is the number of additional
iterations, which will be added to the previous total. Defaults to 100
if missing.</p></li>
<li><p><code>&lt;chain&gt;</code> Specifies the number of MCMC chains to
be run. Defaults to 2. Note that some of the post-processing functions
will look for at least 2 chains for diagnostics.</p></li>
<li>
<p><code>&lt;prior&gt;</code> Identifies the prior to be used for
PDA. Can be one of either:</p>
<pre><code> + `&lt;posterior.id&gt;` A posterior ID in BETY specifying the posterior from a previous PEcAn analysis (e.g., meta-analysis or previous PDA) to be used as the prior for PDA. Defaults to the most recent relevant posterior in the database if omitted (and no `&lt;path&gt;` specified instead; see below).

 + `&lt;path&gt;` As an alternative to using a posterior ID, can specify a file path to either a `prior.distns.Rdata` or `post.distns.Rdata` file generated from an earlier analysis. Conceptually, using a posterior distribution as the prior for PDA is preferred, as this allows the multiple analyses to work together to iteratively constrain parameters. In practice, previous analyses may have over-constrained parameters to ranges that do not actually optimize model outputs, so using a less informative prior for PDA might yield better results. 

 NOTE: It is recommended to leave the `&lt;prior&gt;` tag empty if you are doing this for the first time. PEcAn workflow will handle it for you.</code></pre>
</li>
<li><p><code>&lt;param.names&gt;</code> The names of parameters to be
constrained by assimilation, listed in individual
<code>&lt;param&gt;</code> tags. <em>These must be the standard names
given in BETY DB (e.g. wood_density), not your model specific parameter
names (e.g. wooddens)</em>, i.e. check out the <code>id</code> column of
the <code>trait.dictionary</code>, i.e. :</p></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">trait.dictionary</span>, package <span class="op">=</span> <span class="st">"PEcAn.utils"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">trait.dictionary</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"figid"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                         id                   figid</span></span>
<span><span class="co">## 1           plant_min_temp          Plant Min Temp</span></span>
<span><span class="co">## 2                      GDD     Growing Degree Days</span></span>
<span><span class="co">## 3                    leafC            Leaf C conc.</span></span>
<span><span class="co">## 4                 c2n_leaf                Leaf C:N</span></span>
<span><span class="co">## 5 leaf_respiration_rate_m2   Leaf Respiration Rate</span></span>
<span><span class="co">## 6  dark_respiration_factor Dark Respiration Factor</span></span></code></pre>
<p>You can inspect your <code>write.config.MODEL.R</code> script for
standard parameter names and their mappings to model parameter
names.</p>
<pre><code>       NOTE : `&lt;param.names&gt;` chunk should always be on your xml file regardless of the method you use in the PDA.
       </code></pre>
<ul>
<li>
<p><code>&lt;inputs&gt;</code> Observation (constraint) data to be
compared to the model. In principle, can be one or more datasets,
specified in a variety of ways. In practice, the code is tested for
assimilating flux datasets numerous times using the NEE/FC or LE
variables.</p>
<ul>
<li>
<code>&lt;file&gt;</code> Denotes a set of tags for a single input
(constraint data). Would be repeated for multiple datasets/variables,
e.g. in this case note the differences in
<code>&lt;variable.id&gt;</code> and <code>&lt;variable.name&gt;</code>
:</li>
</ul>
<pre><code>...
&lt;inputs&gt;
 &lt;file&gt;
  &lt;input.id&gt;15000000028&lt;/input.id&gt;   
  &lt;path&gt;
   &lt;path&gt;/data/dbfiles/ICOS_site_1-266/FLX_FI-Var_FLUXNET2015_FULLSET_HH_2016-2018_beta-3.csv&lt;/path&gt; 
  &lt;/path&gt;
  &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
  &lt;variable.id&gt;297&lt;/variable.id&gt;
  &lt;variable.name&gt;
   &lt;variable.name&gt;NEE&lt;/variable.name&gt;
   &lt;variable.name&gt;UST&lt;/variable.name&gt;
  &lt;/variable.name&gt;
 &lt;/file&gt;   
 &lt;file&gt;
  &lt;input.id&gt;15000000028&lt;/input.id&gt;   
  &lt;path&gt;
   &lt;path&gt;/data/dbfiles/ICOS_site_1-266/FLX_FI-Var_FLUXNET2015_FULLSET_HH_2016-2018_beta-3.csv&lt;/path&gt; 
  &lt;/path&gt;
  &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
  &lt;variable.id&gt;298&lt;/variable.id&gt;
  &lt;variable.name&gt;
   &lt;variable.name&gt;LE&lt;/variable.name&gt;
   &lt;variable.name&gt;UST&lt;/variable.name&gt;
  &lt;/variable.name&gt;
 &lt;/file&gt;
&lt;/inputs&gt;
...</code></pre>
<ul>
<li><p><code>&lt;input.id&gt;</code> BETY input ID for looking up the
input.</p></li>
<li><p><code>&lt;path&gt;</code> File path to the input. Both
<code>&lt;id&gt;</code> and <code>&lt;path&gt;</code> of the observation
data should be supplied for the PDA.</p></li>
<li><p><code>&lt;source&gt;</code> A standardized source of input data
(e.g., Ameriflux). Not implemented yet, but the idea would be similar to
the met workflow, PEcAn would be able to use standard data sources
automatically where available. Only used if no <code>&lt;id&gt;</code>
or <code>&lt;path&gt;</code> is given.</p></li>
<li><p><code>&lt;likelihood&gt;</code> Identifier for the likelihood to
use. E.g., the Ameriflux NEE/FC and LE data use a Laplacian
likelihood.</p></li>
<li><p><code>&lt;hyper.pars&gt;</code> Optional. Hyperparameters for
your likelihood. E.g. Prior parameters of the precision for Gaussian
likelihood. Defaults to scaled values if not provided.</p></li>
<li><p><code>&lt;ss.positive&gt;</code> When using the emulator, it is
important to let the algorithm know that you have a likelihood whose
sufficient statistics is zero bound.</p></li>
<li>
<p><code>&lt;variable.id&gt;</code> The BETY variable ID associated
with this dataset. The idea is that specific preprocessing steps (e.g.,
estimating heteroskedastic error for tower NEE) would be associated with
particular IDs. Could automate further by assigning default
<code>&lt;likelihood&gt;</code> to variable.id values (allowing
<code>&lt;likelihood&gt;</code> to be omitted from pecan.xml).</p>
<pre><code> NOTE : `&lt;inputs&gt;` chunk should always be on your xml file regardless of the method you use in the PDA.</code></pre>
</li>
</ul>
</li>
<li>
<p><code>&lt;jump&gt;</code> Settings for the specifics of the
proposal schema and adaptation functionality. It is used in the
<code>emulator</code> approach, it’s possible to set adaptation options
using <code>bayesian.tools</code> specific tags as well (see below for
<code>&lt;bt.settings&gt;</code>).</p>
<ul>
<li>
<code>&lt;ar.target&gt;</code> Target acceptance rate for the
adaptive jump algorithm. Defaults to 0.5 if missing.</li>
<li>
<code>&lt;adapt&gt;</code> Number of iterations between jump
variance adaptations. Defaults to <code>floor(iter/10)</code> if
missing. If set equal to the number of <code>&lt;iter&gt;</code>,
basically turns off the adaptation functionality, it is not recommended
to turn-off this functionality for the emulator approach.</li>
<li>
<code>&lt;adj.min&gt;</code> Minimum factor by which to reduce jump
variance when adapting. Prevents jump variances from degenerating to 0.
Defaults to 0.1 if missing.</li>
</ul>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="method-specific-settings">Method specific settings<a class="anchor" aria-label="anchor" href="#method-specific-settings"></a>
</h2>
<p>Now we will go through 4 examples of how you could arrange your
<code>&lt;assim.batch&gt;</code> tags and run a PDA in PEcAn:</p>
<ol style="list-style-type: decimal">
<li>Using existing PEcAn data pipelines (e.g. Ameriflux) and variables
in the emulator-based calibration.</li>
<li>Using existing PEcAn data pipelines and variables in the
BayesianTools-based (bruteforce) calibration.</li>
<li>Using your own pre-formatted data and variables in the
emulator-based calibration.</li>
<li>Using your own pre-formatted data and variables in the
BayesianTools-based (bruteforce) calibration.</li>
</ol>
</div>
<div class="section level2">
<h2 id="pecan-data-pipeline-with-emulator">1. PEcAn data pipeline with emulator<a class="anchor" aria-label="anchor" href="#pecan-data-pipeline-with-emulator"></a>
</h2>
<p>Assuming you already familiarized yourself with Demo 1 and Demo 2,
and ran SIPNET at Niwot Ridge (US-NR1), in this section we will go
through the <code>pecan.xml</code> tags for calibrating SIPNET with
Ameriflux NEE data with the emulator approach at the US-NR1 site. The
SIPNET PFT for this site was <code>temperate.coniferous</code>, let’s
assume the top three parameters contributing to the model NEE output
uncertainty (Demo 2) were
<code>psnTOpt</code>,<code>half_saturation_PAR</code>, and
<code>Vm_low_temp</code>, so we decided to constrain these in the PDA.
Go to your workflow directory where you performed the uncertainty
analysis, open up your <code>pecan.CONFIGS.xml</code>, insert the
following tags at the top of your xml after the
<code>&lt;pecan&gt;</code> tag (don’t forget to remove
<code>&lt;---</code> comments), modify the paths according to
<em>your</em> setup, and save the file as
<code>pecan.PDA.xml</code>:</p>
<pre><code> &lt;assim.batch&gt;
  &lt;method&gt;emulator&lt;/method&gt;
  &lt;n.knot&gt;60&lt;/n.knot&gt;   &lt;--- 20 x p (= no. of paramaters you target) 
  &lt;iter&gt;100000&lt;/iter&gt;
  &lt;chain&gt;3&lt;/chain&gt;
  &lt;param.names&gt;
   &lt;temperate.coniferous&gt;
    &lt;param&gt;psnTOpt&lt;/param&gt;
    &lt;param&gt;half_saturation_PAR&lt;/param&gt;
    &lt;param&gt;Vm_low_temp&lt;/param&gt;
   &lt;/temperate.coniferous&gt;
  &lt;/param.names&gt;
  &lt;jump&gt;
   &lt;adapt&gt;250&lt;/adapt&gt;
    &lt;adj.min&gt;0.1&lt;/adj.min&gt;
    &lt;ar.target&gt;0.3&lt;/ar.target&gt;
  &lt;/jump&gt;
  &lt;inputs&gt;
   &lt;file&gt;
    &lt;input.id&gt;1000011238&lt;/input.id&gt;   &lt;--- your input ID (of the DB record of where the AMF csv file is)
    &lt;path&gt;
     &lt;path&gt;/.../AmerifluxLBL_site_0-772/AMF_US-NR1_BASE_HH_12-5.csv&lt;/path&gt;  &lt;--- your path
    &lt;/path&gt;
    &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
    &lt;variable.id&gt;1000000042&lt;/variable.id&gt;
    &lt;variable.name&gt;
     &lt;variable.name&gt;FC&lt;/variable.name&gt;
     &lt;variable.name&gt;UST&lt;/variable.name&gt;
    &lt;/variable.name&gt;
   &lt;/file&gt;
  &lt;/inputs&gt;
 &lt;/assim.batch&gt;</code></pre>
<p>For reference, these are the tags for a similar workflow for SIPNET
at ICOS-NEE (FI-Var site) combination. Note the differences in PFT name,
input ID and path, variable ID and name:</p>
<pre><code> &lt;assim.batch&gt;
  &lt;method&gt;emulator&lt;/method&gt;
  &lt;n.knot&gt;60&lt;/n.knot&gt;   
  &lt;iter&gt;100000&lt;/iter&gt;
  &lt;chain&gt;3&lt;/chain&gt;
  &lt;param.names&gt;
   &lt;boreal.coniferous&gt;
    &lt;param&gt;psnTOpt&lt;/param&gt;
    &lt;param&gt;half_saturation_PAR&lt;/param&gt;
    &lt;param&gt;Vm_low_temp&lt;/param&gt;
   &lt;/boreal.coniferous&gt;
  &lt;/param.names&gt;
  &lt;jump&gt;
   &lt;adapt&gt;250&lt;/adapt&gt;
    &lt;adj.min&gt;0.1&lt;/adj.min&gt;
    &lt;ar.target&gt;0.3&lt;/ar.target&gt;
  &lt;/jump&gt;
  &lt;inputs&gt;
   &lt;file&gt;
    &lt;input.id&gt;15000000028&lt;/input.id&gt;  
    &lt;path&gt;
     &lt;path&gt;/.../ICOS_site_1-266/FLX_FI-Var_FLUXNET2015_FULLSET_HH_2016-2018_beta-3.csv&lt;/path&gt;  
    &lt;/path&gt;
    &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
    &lt;variable.id&gt;297&lt;/variable.id&gt;
    &lt;variable.name&gt;
     &lt;variable.name&gt;NEE&lt;/variable.name&gt;
     &lt;variable.name&gt;UST&lt;/variable.name&gt;
    &lt;/variable.name&gt;
   &lt;/file&gt;
  &lt;/inputs&gt;
 &lt;/assim.batch&gt;</code></pre>
<p>Now you can read in your <code>pecan.PDA.xml</code> and run PDA (This
will take some time, go grab a drink. The first round especially takes
time because this is when the constraint data is loaded and its
effective sample size is calculated):</p>
<pre><code><span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu">read.settings</span><span class="op">(</span><span class="st">"pecan.PDA.xml"</span><span class="op">)</span></span>
<span><span class="va">settings_PDA_round1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pda.emulator.html">pda.emulator</a></span><span class="op">(</span><span class="va">settings</span><span class="op">)</span></span></code></pre>
<p>The PDA workflow has populated you <code>settings</code> list object
with couple of relevant tags. Now <code>settings_PDA_round1</code> has
these additional tags (note that this post-PDA <code>settings</code>
list is also automatically written to your workflow directory as
<code>pecan.pdaR1_ENS_ID.xml</code>). These tags look like this:</p>
<pre><code>  &lt;prior&gt;
   &lt;prior.id&gt;
    &lt;boreal.coniferous&gt;INITIAL_PDA_PRIOR_ID&lt;/boreal.coniferous&gt;
   &lt;/prior.id&gt;
  &lt;/prior&gt;
  &lt;ensemble.id&gt;
   &lt;id&gt;R1_ENS_ID&lt;/id&gt;
  &lt;/ensemble.id&gt;
  &lt;emulator.path&gt;/.../PEcAn_WORKFLOWID/emulator.pdaR1_ENS_ID.Rdata&lt;/emulator.path&gt;
  &lt;ss.path&gt;/.../PEcAn_WORKFLOWID/ss.pdaR1_ENS_ID.Rdata&lt;/ss.path&gt;
  &lt;mcmc.path&gt;/.../PEcAn_WORKFLOWID/mcmc.list.pdaR1_ENS_ID.Rdata&lt;/mcmc.path&gt;
  &lt;resume.path&gt;/.../PEcAn_WORKFLOWID/resume.pdaR1_ENS_ID.Rdata&lt;/resume.path&gt;
  &lt;round_counter&gt;1&lt;/round_counter&gt;
  &lt;extension&gt;round&lt;/extension&gt;
</code></pre>
<ul>
<li><p><code>&lt;prior.id&gt;</code> This is the initial prior that went
into your first PDA round. Even though the PDA workflow updates the
<code>&lt;posteriorid&gt;</code> under your PFT block, if you do another
emulator round only the initial prior will be used in the MCMC
(otherwise you use data twice!). Hence, we keep track of its ID in the
xml. But it is still perfectly fine to propose the new training points
for the next emulator round from the posterior of the previous round, so
that you can refine your emulator surface, that’s when the PDA workflow
uses <code>&lt;posteriorid&gt;</code> under the hood.</p></li>
<li><p><code>&lt;ensemble.id&gt;</code> Each emulator round is assigned
a new ensemble ID. You can see this ID in every file recorded for the
associated emulator round, e.g.:
<code>history.pdaR1_ENS_ID.Rdata</code>,
<code>pecan.pdaR1_ENS_ID.xml</code>,
<code>post.distns.pda.YOURPFT_R1_ENS_ID.Rdata</code> etc.</p></li>
</ul>
<p>Rest of the tags are for the emulator workflow to be able to find
previous rounds’ information and understand what to do in the next
round. The emulator workflow automatically adds
<code>&lt;extension&gt;round&lt;/extension&gt;</code> because if you
forget to add this tag manually after the first round, you will just be
repeating the first round while you almost certainly intend to do an
iterative round if you are using the settings of your previous round.
Forgetting to add this tag has happened enough times that we now add
this tag automatically. But note that in PDA we have a second type of
extension which is
<code>&lt;extension&gt;longer&lt;/extension&gt;</code>. This is to run
your MCMC chain longer in case it didn’t converge. This will be more of
an issue for the bruteforce calibration (see below), but it is also
possible to run your MCMC chains longer if your emulator-based MCMC also
didn’t converge:</p>
<ul>
<li>
<p><code>&lt;extension&gt;</code> Specifies the extension type of
additional emulator runs, should be skipped if this a first emulator run
of its own. Otherwise it is possible to extend emulator PDA runs in two
ways:</p>
<ul>
<li><p><code>&lt;extension&gt;longer&lt;/extension&gt;</code> using the
same emulator, this extension run takes the MCMC sampling from where it
was left in the previous emulator run and runs a longer MCMC
chain.</p></li>
<li><p><code>&lt;extension&gt;round&lt;/extension&gt;</code> this
extension run proposes new points in the parameter space in addition to
the previous ones, and builds a new emulator including these additional
points for a new MCMC sampling. These new points can come from both your
inital PDA prior and the posterior of your first round of emulator run.
You can determine the percentage of new knots coming from the posterior
of your previous run in the <code>&lt;knot.par&gt;</code> tag. If you
leave it empty, 90% of your new points will be drawn from the posterior
of your previous run by default.</p></li>
</ul>
</li>
</ul>
<p>Now you can either pass the post PDA settings in your environment to
the <code><a href="../reference/pda.emulator.html">pda.emulator()</a></code> function again (yes you can put this in
a loop) or you can re-read your <code>pecan.pdaR1_ENS_ID.xml</code> at
any time to perform an iterative emulator round.</p>
<pre><code><span><span class="co">### settings_PDA_round1 &lt;- read.settings("pecan.pdaR1_ENS_ID.xml")</span></span>
<span><span class="va">settings_PDA_round2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pda.emulator.html">pda.emulator</a></span><span class="op">(</span><span class="va">settings_PDA_round1</span><span class="op">)</span></span></code></pre>
<p>Before moving on to the <code>BayesianTools</code> case, here is what
your <code>pecan.PDA.xml</code> could look like for a case where you
constrain parameters of more than one model PFT with more than one
Ameriflux data stream, note the ordering in
<code>&lt;assim.batch&gt;&lt;param.names&gt;</code> and
<code>&lt;pfts&gt;</code>:</p>
<pre><code>...
 &lt;assim.batch&gt;
  ...
  &lt;param.names&gt;
   &lt;PFT1&gt;
    &lt;param&gt;PFT1_PDA_param1&lt;/param&gt;
    &lt;param&gt;PFT1_PDA_param2&lt;/param&gt;
   &lt;/PFT1&gt;
   &lt;PFT2&gt;
    &lt;param&gt;PFT2_PDA_param1&lt;/param&gt;
    &lt;param&gt;PFT2_PDA_param2&lt;/param&gt;
    &lt;param&gt;PFT2_PDA_param3&lt;/param&gt;
   &lt;/PFT2&gt;
  &lt;/param.names&gt;
  ...
  &lt;inputs&gt;
   &lt;file&gt;
    &lt;input.id&gt;YOURINPUTID&lt;/input.id&gt;   
    &lt;path&gt;
     &lt;path&gt;/YOURPATH/AmerifluxLBL_site_***/AMF_***_BASE_HH_***.csv&lt;/path&gt; 
    &lt;/path&gt;
    &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
    &lt;variable.id&gt;297&lt;/variable.id&gt;
    &lt;variable.name&gt;
     &lt;variable.name&gt;NEE&lt;/variable.name&gt;
     &lt;variable.name&gt;UST&lt;/variable.name&gt;
    &lt;/variable.name&gt;
   &lt;/file&gt;   
   &lt;file&gt;
    &lt;input.id&gt;YOURINPUTID&lt;/input.id&gt;   
    &lt;path&gt;
     &lt;path&gt;/YOURPATH/AmerifluxLBL_site_***/AMF_***_BASE_HH_***.csv&lt;/path&gt; 
    &lt;/path&gt;
    &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
    &lt;variable.id&gt;298&lt;/variable.id&gt;
    &lt;variable.name&gt;
     &lt;variable.name&gt;LE&lt;/variable.name&gt;
     &lt;variable.name&gt;UST&lt;/variable.name&gt;
    &lt;/variable.name&gt;
   &lt;/file&gt;
  &lt;/inputs&gt;
  ...
 &lt;/assim.batch&gt;
 ...
 &lt;pfts&gt;
  &lt;pft&gt;
   &lt;name&gt;PFT1&lt;/name&gt;
   &lt;outdir&gt;/YOUR/WORKFLOWS/PATH/PEcAn_WORKFLOWID/pft/PFT1&lt;/outdir&gt;
   &lt;posteriorid&gt;PFT1_POSTID&lt;/posteriorid&gt;
  &lt;/pft&gt;
  &lt;pft&gt;
   &lt;name&gt;PFT2&lt;/name&gt;
   &lt;outdir&gt;/YOUR/WORKFLOWS/PATH/PEcAn_WORKFLOWID/pft/PFT2&lt;/outdir&gt;
   &lt;posteriorid&gt;PFT2_POSTID&lt;/posteriorid&gt;
  &lt;/pft&gt;
 &lt;/pfts&gt;
 ...</code></pre>
</div>
<div class="section level2">
<h2 id="pecan-data-pipeline-with-bayesiantools">2. PEcAn data pipeline with BayesianTools<a class="anchor" aria-label="anchor" href="#pecan-data-pipeline-with-bayesiantools"></a>
</h2>
<p>Using the bruteforce PDA approach with one of the MCMC-flavors as
implemented in the BayesianTools R-package requires slightly different
tags to configure its setup. <strong>pda.bayesian.tools()</strong> would
look for sampler specific settings that can be passed through the
pecan.xml as a block under the <code>&lt;bt.settings&gt;</code> tag.
Currently, the available samplers in the BayesianTools package are:</p>
<ul>
<li>Metropolis
<ul>
<li>Standard MH-MCMC</li>
<li>With pre-optimization</li>
<li>Adaptive MCMC</li>
<li>Delayed rejection</li>
<li>Gibbs updating</li>
</ul>
</li>
<li>M : Another implementation of standard MH-MCMC.</li>
<li>AM : Adaptive Metropolis</li>
<li>DR : Delayed Rejection</li>
<li>DRAM : Delayed Rejection Adaptive Metropolis</li>
<li>DE : Differential Evolution</li>
<li>DEzs : Differential Evolution with a snooker updater</li>
<li>DREAM : Differential Evolution Adaptive Metropolis</li>
<li>DREAMzs : Differential Evolution Adaptive Metropolis with a snooker
updater</li>
<li>Twalk : “traverse” or “thoughtful” walk, a general purpose sampling
algorithm</li>
<li>SMC : Sequential Monte Carlo</li>
</ul>
<p>Note that it is not possible to use some of the samplers in this
package for univariate cases. The ones that you can use for univariate
cases are: “Metropolis”, “DE”, “DEzs” and “Twalk”. Some of the samplers
are also restartable : “Metropolis”, “DE”, “DEzs”, “DREAM”, “DREAMzs”,
“Twalk”. For further details please see the BayesianTools documentation
which itself has a helpful vignette.</p>
<p>The name of the chosen sampler would be passed under
<code>&lt;sampler&gt;</code> tag within the
<code>&lt;bt.settings&gt;</code> block. E.g. for Metropolis
variations:</p>
<pre><code>  ...
  &lt;method&gt;bayesian.tools&lt;/method&gt;
  &lt;bt.settings&gt;
    &lt;iter&gt;10000&lt;/iter&gt;
    &lt;sampler&gt;Metropolis&lt;/sampler&gt;
    &lt;DRlevels&gt;1&lt;/DRlevels&gt;                               &lt;-- set 2 for Delayed Rejection
    &lt;optimize&gt;FALSE&lt;/optimize&gt;                           &lt;-- set TRUE for pre-optimization
    &lt;adapt&gt;FALSE&lt;/adapt&gt;                                 &lt;-- set TRUE for Adaptive Metropolis
    &lt;adaptationNotBefore&gt;500&lt;/adaptationNotBefore&gt;       &lt;-- set for Adaptive Metropolis
  &lt;/bt.settings&gt;
  ...</code></pre>
<p>The rest of the <code>&lt;assim.batch&gt;</code> block is the same
(except you can now omit the <code>&lt;jump&gt;</code> tag as it takes
no effect in this case). While all the algorithms can be accessed by the
“Metropolis” sampler in BayesianTools package by specifying the
sampler’s settings, it could be easier to directly pass the sampler name
explicitly. Below is an example for DREAMzs (recommended) algorithm:</p>
<pre><code> &lt;assim.batch&gt;
   &lt;method&gt;bayesian.tools&lt;/method&gt;
   &lt;bt.settings&gt;
     &lt;sampler&gt;DREAMzs&lt;/sampler&gt;
     &lt;iter&gt;10000&lt;/iter&gt;
     &lt;chain&gt;3&lt;/chain&gt;
   &lt;/bt.settings&gt;
  &lt;param.names&gt;
   &lt;soil&gt;
    &lt;param&gt;som_respiration_rate&lt;/param&gt;
   &lt;/soil&gt;
   &lt;boreal.coniferous&gt;
    &lt;param&gt;psnTOpt&lt;/param&gt;
    &lt;param&gt;half_saturation_PAR&lt;/param&gt;
    &lt;param&gt;Vm_low_temp&lt;/param&gt;
   &lt;/boreal.coniferous&gt;
  &lt;/param.names&gt;
  &lt;inputs&gt;
   &lt;file&gt;
    &lt;input.id&gt;15000000028&lt;/input.id&gt;   
    &lt;path&gt;
     &lt;path&gt;/data/dbfiles/ICOS_site_1-266/FLX_FI-Var_FLUXNET2015_FULLSET_HH_2016-2018_beta-3.csv&lt;/path&gt; 
    &lt;/path&gt;
    &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
    &lt;variable.id&gt;297&lt;/variable.id&gt;
    &lt;variable.name&gt;
     &lt;variable.name&gt;NEE&lt;/variable.name&gt;
     &lt;variable.name&gt;UST&lt;/variable.name&gt;
    &lt;/variable.name&gt;
   &lt;/file&gt;
  &lt;/inputs&gt;
 &lt;/assim.batch&gt;</code></pre>
<p>Assuming you save these tags under a <code>pecan.PDA.xml</code></p>
<pre><code><span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu">read.settings</span><span class="op">(</span><span class="st">"pecan.PDA.xml"</span><span class="op">)</span></span>
<span><span class="va">settings_postPDA</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pda.bayesian.tools.html">pda.bayesian.tools</a></span><span class="op">(</span><span class="va">settings</span><span class="op">)</span></span></code></pre>
<p>In case of no convergence and/or if you would like to run the same
chains longer, you can add the extension option:</p>
<pre><code><span><span class="va">settings_postPDA</span><span class="op">$</span><span class="va">assim.batch</span><span class="op">$</span><span class="va">extension</span> <span class="op">&lt;-</span> <span class="st">'longer'</span></span>
<span><span class="va">settings_postPDA_longer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pda.bayesian.tools.html">pda.bayesian.tools</a></span><span class="op">(</span><span class="va">settings_postPDA</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="own-data-with-emulator">3. Own data with emulator<a class="anchor" aria-label="anchor" href="#own-data-with-emulator"></a>
</h2>
<p>Sometimes you might want to use your own local data (e.g. from a
tower that is not necessarily part of any flux tower network PEcAn has
access to, or some chamber measurements etc.) for constraining your
model. Although we still do recommend using formal PEcAn data
registration and processing pipelines, sometimes you may not have access
to the DB and/or may want to bypass other data processing steps to
perform a quick PDA analysis to plan ahead. In that case, you can use
<code>external.*</code> arguments of the <code><a href="../reference/pda.emulator.html">pda.emulator()</a></code>
function. You can prepare the <code>external.*</code> arguments
manually, but the easiest way to generate them is to use
<code><a href="../reference/pda.generate.externals.html">pda.generate.externals()</a></code> function that you can find under
the script with the same name. <code><a href="../reference/pda.emulator.html">pda.emulator()</a></code> function
accepts the following <code>external.*</code> arguments:</p>
<ul>
<li><p><code>external.data</code> This is a list containing your
constraining variables in the format expected by the PDA functions (see
also <code><a href="../reference/pda.generate.externals.html">pda.generate.externals()</a></code> function). The length of this
list is the number of your data streams (e.g. if you are using NEE and
LE in calibration, it will have two sublists). <em>Hint: You may want to
perform case #1 and load the <code>history.pda</code> file to check the
format of the <code>inputs</code> object out, because if
<code>external.data</code> is passed to the <code><a href="../reference/pda.emulator.html">pda.emulator()</a></code>
it will simply be assined to this variable,
<code>inputs &lt;- external.data</code>.</em> To be able to prepare
<code>external.data</code> with the
<code><a href="../reference/pda.generate.externals.html">pda.generate.externals()</a></code> function you need your data as a(n
ordered) list where each sublist corresponds to a data frame of your
constraining variable with two columns, variable name - posix.</p></li>
<li><p><code>external.formats</code> This is a list of variable names in
the format expected by the PDA functions (see also
<code><a href="../reference/pda.generate.externals.html">pda.generate.externals()</a></code> function). The length of this list
is the number of your data streams (e.g. if you are using NEE and LE in
calibration, it will have two sublists). Depending on expressions
provided in this object, PDA functions are capable of performing simple
derivations on data. Hence, this list has a slightly more complex
structure than a simple list of names, but don’t worry about it. To be
able to prepare <code>external.formats</code> with the
<code><a href="../reference/pda.generate.externals.html">pda.generate.externals()</a></code> it is enough to pass
<code>varn</code> vector that has the standard variable names (when in
doubt, check the standard variable names under
<code>/base/utils/data/standard_vars.csv</code>).</p></li>
<li><p><code>external.priors</code> This is a list of pecan probability
distribution dataframes to be used as PDA priors, one sublist per PFT,
e.g.:</p></li>
</ul>
<pre><code>[[1]]
                       distn parama  paramb  n
frozenSoilEff           beta  1.000    1.00 NA
soilRespMoistEffect     unif  0.000    2.00 NA
...

[[2]]
                              distn      parama       paramb   n
growth_resp_factor             beta       2.630      6.5e+00   0
root_respiration_rate          norm       8.700      9.5e-01  NA
...</code></pre>
<ul>
<li>
<code>external.knots</code> This is a list of dataframes containing
emulator training points. Only pass it if you want to build the emulator
on specific knots over which you want to have control, otherwise knots
are generated from the PDA priors using Latin Hypercube Sampling. Each
sublist should be a <code>nknot x nPFTparam</code> dataframe, e.g. if
you are building an emulator with 250 knots and your PFT has 30
parameters, this will be a 250 x 30 dataframe where each row is a
parameter vector. Therefore only the columns of parameters that you are
targeting in PDA should have varying parameter values. E.g. if you are
calibrating the <code>psnTOpt</code> parameter, it would look like
this:</li>
</ul>
<pre><code>&gt; external.knots
$temperate.deciduous
        ...  half_saturation_PAR fine_root_respiration_Q10   psnTOpt  AmaxFrac   ...
  [1,]  ...                 15.5                       3.2  24.83626 0.8605507   ...   
  [2,]  ...                 15.5                       3.2  25.18056 0.8605507   ...
  [3,]  ...                 15.5                       3.2  26.10204 0.8605507   ...
  [4,]  ...                 15.5                       3.2  25.03353 0.8605507   ...
   ...  ...                 ...                        ...       ...       ...   ...</code></pre>
<p>Once you prepare <code>external.data</code> and
<code>external.format</code>, now you can omit the
<code>&lt;input.id&gt;&lt;/input.id&gt;</code> and
<code>&lt;path&gt;&lt;/path&gt;</code> tags in the
<code>&lt;assim.batch&gt;</code> block (they will be ignored even if you
pass them when <code>external.data</code> is not NULL:</p>
<pre><code> &lt;assim.batch&gt;
  &lt;method&gt;emulator&lt;/method&gt;
  &lt;n.knot&gt;60&lt;/n.knot&gt;   
  &lt;iter&gt;100000&lt;/iter&gt;
  &lt;chain&gt;3&lt;/chain&gt;
  &lt;param.names&gt;
   &lt;boreal.coniferous&gt;
    &lt;param&gt;psnTOpt&lt;/param&gt;
    &lt;param&gt;half_saturation_PAR&lt;/param&gt;
    &lt;param&gt;Vm_low_temp&lt;/param&gt;
   &lt;/boreal.coniferous&gt;
  &lt;/param.names&gt;
  &lt;jump&gt;
   &lt;adapt&gt;250&lt;/adapt&gt;
    &lt;adj.min&gt;0.1&lt;/adj.min&gt;
    &lt;ar.target&gt;0.3&lt;/ar.target&gt;
  &lt;/jump&gt;
  &lt;inputs&gt;
   &lt;file&gt;
    &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
    &lt;variable.id&gt;297&lt;/variable.id&gt;
    &lt;variable.name&gt;
     &lt;variable.name&gt;NEE&lt;/variable.name&gt;
     &lt;variable.name&gt;UST&lt;/variable.name&gt;
    &lt;/variable.name&gt;
   &lt;/file&gt;
  &lt;/inputs&gt;
 &lt;/assim.batch&gt;</code></pre>
<p>Save and read your <code>pecan.PDA.xml</code> accordingly. Next, pass
the external data and formats you prepared explicitly to the
<code><a href="../reference/pda.emulator.html">pda.emulator()</a></code> function:</p>
<pre><code><span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu">read.settings</span><span class="op">(</span><span class="st">"pecan.PDA.xml"</span><span class="op">)</span></span>
<span><span class="va">pda.externals</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/pda.generate.externals.html">pda.generate.externals</a></span><span class="op">(</span>external.data <span class="op">=</span> <span class="cn">TRUE</span>, obs <span class="op">=</span> <span class="va">obs</span>, varn <span class="op">=</span> <span class="st">"NEE"</span>, varid <span class="op">=</span> <span class="fl">297</span>, external.formats <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span>
<span><span class="va">settings_postPDA</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pda.emulator.html">pda.emulator</a></span><span class="op">(</span><span class="va">settings</span>, external.data <span class="op">=</span> <span class="va">pda.externals</span><span class="op">$</span><span class="va">external.data</span>, external.formats <span class="op">=</span> <span class="va">pda.externals</span><span class="op">$</span><span class="va">external.formats</span><span class="op">)</span></span></code></pre>
<p>Note that this way we provided external constraint data and its
format information to the PDA functions but we are still using database
connection. If you want to use PDA functions with no database
connection, then you need to provide prior list to the function as an
external object as well and run it in <code>remote = TRUE</code> mode.
In that case, it is also recommended to pass an <code>ensemble.id</code>
as an identifier for your PDA run (normally this is given by the PDA
workflow), it can even be a string:</p>
<pre><code><span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu">read.settings</span><span class="op">(</span><span class="st">"pecan.PDA.xml"</span><span class="op">)</span></span>
<span><span class="va">prior.list</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>distn  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"unif"</span>, <span class="st">"unif"</span>, <span class="st">"norm"</span><span class="op">)</span>, </span>
<span>                               parama <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">4</span>, <span class="fl">0</span><span class="op">)</span>,  </span>
<span>                               paramb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">27</span>, <span class="fl">3</span><span class="op">)</span>,   </span>
<span>                               n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">3</span><span class="op">)</span>, </span>
<span>                               row.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"psnTOpt"</span>, <span class="st">"half_saturation_PAR"</span>, <span class="st">"Vm_low_temp"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pda.externals</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/pda.generate.externals.html">pda.generate.externals</a></span><span class="op">(</span>external.data    <span class="op">=</span> <span class="cn">TRUE</span>, obs <span class="op">=</span> <span class="va">obs</span>, varn <span class="op">=</span> <span class="st">"NEE"</span>, varid <span class="op">=</span> <span class="fl">297</span>, external.formats <span class="op">=</span> <span class="cn">TRUE</span>, external.priors  <span class="op">=</span> <span class="cn">TRUE</span>, prior.list <span class="op">=</span> <span class="va">prior.list</span><span class="op">)</span> </span>
<span><span class="va">settings_postPDA</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pda.emulator.html">pda.emulator</a></span><span class="op">(</span><span class="va">settings</span>, external.data    <span class="op">=</span> <span class="va">pda.externals</span><span class="op">$</span><span class="va">external.data</span>, </span>
<span>                                           external.formats <span class="op">=</span> <span class="va">pda.externals</span><span class="op">$</span><span class="va">external.formats</span>,</span>
<span>                                           external.priors  <span class="op">=</span> <span class="va">pda.externals</span><span class="op">$</span><span class="va">external.priors</span>, </span>
<span>                                           remote <span class="op">=</span> <span class="cn">TRUE</span>, ensemble.id <span class="op">=</span> <span class="st">"PDA_VIGNETTE"</span><span class="op">)</span></span></code></pre>
<p>Two more notes here before moving onto the next case. Above, in the
<code>prior.list</code> object, we only passed prior distribution for
the three parameters we target. In this case rest of the model
parameters will be kept as their defaults (whichever way it is
implemented in the model package), <em>they won’t be kept at the medians
of their prior range as it is normally the case in PDA because we
haven’t passed a prior (range) for them</em>. If you don’t want that to
happen, pass a more comprehensive list or try to use prior (or meta
analysis posterior) objects generated by PEcAn workflows. Finally, we
haven’t used the <code>external.knots</code> argument yet. We only use
it when we need to overwrite and enforce the training points for the
emulator and don’t necessarily need to populate this argument when doing
PDA without database connection. We leave testing with
<code>external.knots</code> as an exercise.</p>
</div>
<div class="section level2">
<h2 id="own-data-with-bayesiantools">4. Own data with BayesianTools<a class="anchor" aria-label="anchor" href="#own-data-with-bayesiantools"></a>
</h2>
<p>It’s all very much the same as the cases above, in combination of #2
(prepare <code>BayesianTools</code> specific xml tags) and #3 (prepare
external arguments).</p>
<pre><code> &lt;assim.batch&gt;
   &lt;method&gt;bayesian.tools&lt;/method&gt;
   &lt;bt.settings&gt;
     &lt;sampler&gt;DREAMzs&lt;/sampler&gt;
     &lt;iter&gt;10000&lt;/iter&gt;
     &lt;chain&gt;3&lt;/chain&gt;
   &lt;/bt.settings&gt;
  &lt;param.names&gt;
   &lt;boreal.coniferous&gt;
    &lt;param&gt;psnTOpt&lt;/param&gt;
    &lt;param&gt;half_saturation_PAR&lt;/param&gt;
    &lt;param&gt;Vm_low_temp&lt;/param&gt;
   &lt;/boreal.coniferous&gt;
  &lt;/param.names&gt;
  &lt;inputs&gt;
   &lt;file&gt;
    &lt;likelihood&gt;Laplace&lt;/likelihood&gt;
    &lt;variable.id&gt;297&lt;/variable.id&gt;
    &lt;variable.name&gt;
     &lt;variable.name&gt;NEE&lt;/variable.name&gt;
     &lt;variable.name&gt;UST&lt;/variable.name&gt;
    &lt;/variable.name&gt;
   &lt;/file&gt;
  &lt;/inputs&gt;
 &lt;/assim.batch&gt;</code></pre>
<p>Save and read your <code>pecan.PDA.xml</code> accordingly. Next, pass
the external data and formats you prepared explicitly to the
<code><a href="../reference/pda.bayesian.tools.html">pda.bayesian.tools()</a></code> function:</p>
<pre><code><span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu">read.settings</span><span class="op">(</span><span class="st">"pecan.PDA.xml"</span><span class="op">)</span></span>
<span><span class="va">pda.externals</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/pda.generate.externals.html">pda.generate.externals</a></span><span class="op">(</span>external.data    <span class="op">=</span> <span class="cn">TRUE</span>, obs <span class="op">=</span> <span class="va">obs</span>, varn <span class="op">=</span> <span class="st">"NEE"</span>, varid <span class="op">=</span> <span class="fl">297</span>, external.formats <span class="op">=</span> <span class="cn">TRUE</span>, external.priors  <span class="op">=</span> <span class="cn">TRUE</span>, prior.list <span class="op">=</span> <span class="va">prior.list</span><span class="op">)</span> </span>
<span><span class="va">settings_postPDA</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pda.bayesian.tools.html">pda.bayesian.tools</a></span><span class="op">(</span><span class="va">settings</span>, external.data    <span class="op">=</span> <span class="va">pda.externals</span><span class="op">$</span><span class="va">external.data</span>, </span>
<span>                                           external.formats <span class="op">=</span> <span class="va">pda.externals</span><span class="op">$</span><span class="va">external.formats</span>,</span>
<span>                                           external.priors  <span class="op">=</span> <span class="va">pda.externals</span><span class="op">$</span><span class="va">external.priors</span>, </span>
<span>                                           remote <span class="op">=</span> <span class="cn">TRUE</span>, ensemble.id <span class="op">=</span> <span class="st">"PDA_VIGNETTE"</span><span class="op">)</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mike Dietze, Istem Fer, Ryan Kelly.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
