<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Running MAAT in PEcAn • PEcAn.MAAT</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Running MAAT in PEcAn">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">PEcAn.MAAT</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.7.5</small>

    <a href="../index.html" style="padding: 0em 1em">← Up</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/create_amerifluxLBL_drivers_for_maat.html">PEcAn: Generating met drivers for the MAAT model using AmerifluxLBL tower observations</a></li>
    <li><a class="dropdown-item" href="../articles/running_maat_in_pecan.html">Running MAAT in PEcAn</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Running MAAT in PEcAn</h1>
                        <h4 data-toc-skip class="author">Shawn
Serbin</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/PecanProject/pecan/blob/develop/models/maat/vignettes/running_maat_in_pecan.Rmd" class="external-link"><code>vignettes/running_maat_in_pecan.Rmd</code></a></small>
      <div class="d-none name"><code>running_maat_in_pecan.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>A simple example to show how to setup and run MAAT simulations within
the PEcAn framework. Running the MAAT model within PEcAn provides access
to additional tools such as the PEcAn met process functions that enable
the creation of model-specific met driver files using various sources
such as reanalysis products including CRU-NCEP and NARR, as well as
site-level tower observations from AmerifluxLBL and FLUXNET. In
addition, the PEcAn framework provides the ability to define custom
plant functional types (PFTs) for MAAT simulation and conduct
multi-ensemble simulations using observationally-constrained MAAT
parameter distributions based on a hierarchical Bayesian meta-analysis
approach linked to the BETYdb trait database (betydb.org).</p>
<p>Presently the full MAAT process representation, functionality and
tools are not yet fully enabled in the PEcAn framework but adding in
more the MAAT functionality is planned in future updates to the PEcAn
wrapper code.</p>
<div class="section level3">
<h3 id="maat-installation-and-usage">MAAT Installation and usage<a class="anchor" aria-label="anchor" href="#maat-installation-and-usage"></a>
</h3>
<p><strong>MAAT model source:</strong> <a href="https://github.com/walkeranthonyp/MAAT" class="external-link uri">https://github.com/walkeranthonyp/MAAT</a> <br> Follow the
instructions found here: <a href="https://github.com/walkeranthonyp/MAAT/blob/master/README.md" class="external-link uri">https://github.com/walkeranthonyp/MAAT/blob/master/README.md</a>
<br></p>
</div>
<div class="section level3">
<h3 id="installing-the-r-packages">Installing the R packages<a class="anchor" aria-label="anchor" href="#installing-the-r-packages"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"repos"</span><span class="op">)</span>, PEcAn <span class="op">=</span> <span class="st">"pecanproject.r-universe.dev"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"PEcAn.MAAT"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pecanproject.github.io" class="external-link">PEcAn.MAAT</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="maat-xml-configuration">MAAT XML configuration<a class="anchor" aria-label="anchor" href="#maat-xml-configuration"></a>
</h3>
<div class="section level4">
<h4 id="e-g--running-without-met-drivers-and-using-user-specified-met-conditions">E.g. Running without met drivers and using user-specified met
conditions<a class="anchor" aria-label="anchor" href="#e-g--running-without-met-drivers-and-using-user-specified-met-conditions"></a>
</h4>
</div>
<div class="section level4">
<h4 id="e-g--running-with-met-drivers">E.g. Running with met drivers<a class="anchor" aria-label="anchor" href="#e-g--running-with-met-drivers"></a>
</h4>
</div>
</div>
<div class="section level3">
<h3 id="full-pecan-xml-configuration-with-maat-options">Full PEcAn XML configuration with MAAT options<a class="anchor" aria-label="anchor" href="#full-pecan-xml-configuration-with-maat-options"></a>
</h3>
<div class="section level4">
<h4 id="e-g--pecan-xml-file-with-maat-configuration-options-">E.g. pecan.xml file with MAAT configuration options.<a class="anchor" aria-label="anchor" href="#e-g--pecan-xml-file-with-maat-configuration-options-"></a>
</h4>
<p>In this example the MAAT model is configured for a temperate
deciduous forest based on the temperate.deciduous PFT in the BETYdb
database (<a href="https://www.betydb.org/pfts/2000000044" class="external-link uri">https://www.betydb.org/pfts/2000000044</a>).</p>
</div>
</div>
<div class="section level3">
<h3 id="simple-maat-run-in-pecan">Simple MAAT run in PEcAn<a class="anchor" aria-label="anchor" href="#simple-maat-run-in-pecan"></a>
</h3>
<p>In this example we will run ten MAAT model ensembles in serial based
on parameter values derived from the temperate.deciduous PFT in the
BETYdb database (<a href="https://www.betydb.org/pfts/2000000044" class="external-link uri">https://www.betydb.org/pfts/2000000044</a>) and the PEcAn
meta analysis step</p>
<p>This chunk is shown but is not currently executed at vignette build
time, because running it requires a connection to the PEcAn
database.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rundir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"maat_pecan_test_run"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">rundir</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="va">rundir</span><span class="op">)</span></span>
<span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu">PEcAn.settings</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.settings/man/read.settings.html" class="external-link">read.settings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"pecan.maat.xml"</span>, package<span class="op">=</span><span class="st">"PEcAn.MAAT"</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">settings</span><span class="op">$</span><span class="va">outdir</span> <span class="op">&lt;-</span> <span class="va">rundir</span></span>
<span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu">PEcAn.settings</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.settings/man/prepare.settings.html" class="external-link">prepare.settings</a></span><span class="op">(</span><span class="va">settings</span>, force<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">PEcAn.logger</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.logger/man/logger.info.html" class="external-link">logger.info</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Main output directory: "</span>,<span class="va">settings</span><span class="op">$</span><span class="va">outdir</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Write pecan.CHECKED.xml</span></span>
<span><span class="fu">PEcAn.settings</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.settings/man/write.settings.html" class="external-link">write.settings</a></span><span class="op">(</span><span class="va">settings</span>, outputfile <span class="op">=</span> <span class="st">"pecan.CHECKED.xml"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># start from scratch if no continue is passed in</span></span>
<span><span class="va">statusFile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">outdir</span>, <span class="st">"STATUS"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/commandArgs.html" class="external-link">commandArgs</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="st">"--continue"</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">statusFile</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.remove</a></span><span class="op">(</span><span class="va">statusFile</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Do conversions</span></span>
<span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu">PEcAn.workflow</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.workflow/man/do_conversions.html" class="external-link">do_conversions</a></span><span class="op">(</span><span class="va">settings</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Query the trait database for data and priors</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.check</a></span><span class="op">(</span><span class="st">"TRAIT"</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.start</a></span><span class="op">(</span><span class="st">"TRAIT"</span><span class="op">)</span></span>
<span>  <span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu">PEcAn.workflow</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.workflow/man/runModule.get.trait.data.html" class="external-link">runModule.get.trait.data</a></span><span class="op">(</span><span class="va">settings</span><span class="op">)</span></span>
<span>  <span class="fu">PEcAn.settings</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.settings/man/write.settings.html" class="external-link">write.settings</a></span><span class="op">(</span><span class="va">settings</span>, outputfile<span class="op">=</span><span class="st">'pecan.TRAIT.xml'</span><span class="op">)</span></span>
<span>  <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.end</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">outdir</span>, <span class="st">'pecan.TRAIT.xml'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu">PEcAn.settings</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.settings/man/read.settings.html" class="external-link">read.settings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">outdir</span>, <span class="st">'pecan.TRAIT.xml'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run the PEcAn meta.analysis</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">meta.analysis</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.check</a></span><span class="op">(</span><span class="st">"META"</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.start</a></span><span class="op">(</span><span class="st">"META"</span><span class="op">)</span></span>
<span>    <span class="fu">PEcAn.MA</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.MA/man/runModule.run.meta.analysis.html" class="external-link">runModule.run.meta.analysis</a></span><span class="op">(</span><span class="va">settings</span><span class="op">)</span></span>
<span>    <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.end</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Write model specific configs</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.check</a></span><span class="op">(</span><span class="st">"CONFIG"</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.start</a></span><span class="op">(</span><span class="st">"CONFIG"</span><span class="op">)</span></span>
<span>  <span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu">PEcAn.workflow</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.workflow/man/runModule.run.write.configs.html" class="external-link">runModule.run.write.configs</a></span><span class="op">(</span><span class="va">settings</span><span class="op">)</span></span>
<span>  <span class="fu">PEcAn.settings</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.settings/man/write.settings.html" class="external-link">write.settings</a></span><span class="op">(</span><span class="va">settings</span>, outputfile<span class="op">=</span><span class="st">'pecan.CONFIGS.xml'</span><span class="op">)</span></span>
<span>  <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.end</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">outdir</span>, <span class="st">'pecan.CONFIGS.xml'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu">PEcAn.settings</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.settings/man/read.settings.html" class="external-link">read.settings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">outdir</span>, <span class="st">'pecan.CONFIGS.xml'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Start MAAT model runs</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.check</a></span><span class="op">(</span><span class="st">"MODEL"</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.start</a></span><span class="op">(</span><span class="st">"MODEL"</span><span class="op">)</span></span>
<span>  <span class="fu">PEcAn.workflow</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.workflow/man/start_model_runs.html" class="external-link">runModule_start_model_runs</a></span><span class="op">(</span><span class="va">settings</span>,stop.on.error<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.end</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">PEcAn.logger</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.logger/man/logger.info.html" class="external-link">logger.info</a></span><span class="op">(</span><span class="st">"*** Wait for model runs to finish. Since this is a serial execution of MAAT, it will take a few minutes ***"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get results of model runs</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.check</a></span><span class="op">(</span><span class="st">"OUTPUT"</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.start</a></span><span class="op">(</span><span class="st">"OUTPUT"</span><span class="op">)</span></span>
<span>  <span class="fu">runModule.get.results</span><span class="op">(</span><span class="va">settings</span><span class="op">)</span></span>
<span>  <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.end</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run ensemble analysis on model output.</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="st">'ensemble'</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">settings</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.check</a></span><span class="op">(</span><span class="st">"ENSEMBLE"</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.start</a></span><span class="op">(</span><span class="st">"ENSEMBLE"</span><span class="op">)</span></span>
<span>  <span class="fu">runModule.run.ensemble.analysis</span><span class="op">(</span><span class="va">settings</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.end</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Pecan workflow complete</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.check</a></span><span class="op">(</span><span class="st">"FINISHED"</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.start</a></span><span class="op">(</span><span class="st">"FINISHED"</span><span class="op">)</span></span>
<span>  <span class="fu">PEcAn.remote</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.remote/man/kill.tunnel.html" class="external-link">kill.tunnel</a></span><span class="op">(</span><span class="va">settings</span><span class="op">)</span></span>
<span>  <span class="fu">db.query</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"UPDATE workflows SET finished_at=NOW() WHERE id="</span>, <span class="va">settings</span><span class="op">$</span><span class="va">workflow</span><span class="op">$</span><span class="va">id</span>, <span class="st">"AND finished_at IS NULL"</span><span class="op">)</span>, params<span class="op">=</span><span class="va">settings</span><span class="op">$</span><span class="va">database</span><span class="op">$</span><span class="va">bety</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Send email if configured</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">email</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">email</span><span class="op">$</span><span class="va">to</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">email</span><span class="op">$</span><span class="va">to</span> <span class="op">!=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">sendmail</span><span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">email</span><span class="op">$</span><span class="va">from</span>, <span class="va">settings</span><span class="op">$</span><span class="va">email</span><span class="op">$</span><span class="va">to</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Workflow has finished executing at "</span>, <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/date.html" class="external-link">date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"You can find the results on "</span>, <span class="va">settings</span><span class="op">$</span><span class="va">email</span><span class="op">$</span><span class="va">url</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/status.html" class="external-link">status.end</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">db.print.connections</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"---------- PEcAn Workflow Complete ----------"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">" "</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">" "</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"---------- Simple ensemble plot ----------"</span><span class="op">)</span></span>
<span><span class="co"># create a simple timeseries plot of the ensemble output</span></span>
<span></span>
<span><span class="co"># get output and calculate some stats</span></span>
<span><span class="va">ensemble_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">settings</span><span class="op">$</span><span class="va">outdir</span>, pattern <span class="op">=</span> <span class="st">"ensemble.ts.NOENSEMBLEID.*Rdata"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">outdir</span>,<span class="va">ensemble_output</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">timeseries_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">ensemble.ts</span><span class="op">$</span><span class="va">assimilation_rate</span>,<span class="fl">2</span>,<span class="va">quantile</span>,probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>,<span class="fl">0.5</span>,<span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create timeseries X axis</span></span>
<span><span class="va">x_axis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">run</span><span class="op">$</span><span class="va">start.date</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">run</span><span class="op">$</span><span class="va">end.date</span><span class="op">)</span>, length.out<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">timeseries_stats</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a new plot window</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.new</a></span><span class="op">(</span>width<span class="op">=</span><span class="fl">14</span>, height<span class="op">=</span><span class="fl">8</span>, unit<span class="op">=</span><span class="st">"in"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">x_axis</span>, <span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/misc.convert.html" class="external-link">misc.convert</a></span><span class="op">(</span><span class="va">timeseries_stats</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span>,<span class="st">"kg C m-2 s-1"</span>,<span class="st">"umol C m-2 s-1"</span><span class="op">)</span>, type<span class="op">=</span><span class="st">"l"</span>,cex<span class="op">=</span><span class="fl">0.00001</span>, col<span class="op">=</span><span class="st">"white"</span>,</span>
<span>     xlab<span class="op">=</span><span class="st">"Time"</span>, ylab<span class="op">=</span><span class="st">"Assimilation_rate (umol/m2/s)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html" class="external-link">polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">x_axis</span> ,<span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">x_axis</span><span class="op">)</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/misc.convert.html" class="external-link">misc.convert</a></span><span class="op">(</span><span class="va">timeseries_stats</span><span class="op">[</span><span class="fl">3</span>,<span class="op">]</span>,<span class="st">"kg C m-2 s-1"</span>,<span class="st">"umol C m-2 s-1"</span><span class="op">)</span>, </span>
<span>                                 <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/misc.convert.html" class="external-link">misc.convert</a></span><span class="op">(</span><span class="va">timeseries_stats</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>,<span class="st">"kg C m-2 s-1"</span>,<span class="st">"umol C m-2 s-1"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        col<span class="op">=</span><span class="st">"#99CC99"</span>,border<span class="op">=</span><span class="st">"#99CC99"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">x_axis</span>,<span class="fu">PEcAn.utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PEcAn.utils/man/misc.convert.html" class="external-link">misc.convert</a></span><span class="op">(</span><span class="va">timeseries_stats</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span>,<span class="st">"kg C m-2 s-1"</span>,<span class="st">"umol C m-2 s-1"</span><span class="op">)</span>,lwd<span class="op">=</span><span class="fl">1</span>, lty<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="st">"light grey"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># close plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Example output MAAT assimilation rate from the five PEcAn model
esemble simulations. The green shaded area represents the ensemble
spread and the grey line shows the mean simulation.</p>
<div class="float">
<img src="graphics%2Fexample_assimilation_rate.png" alt="Example output MAAT assimilation rate from the five PEcAn model esemble simulations"><div class="figcaption">Example output MAAT assimilation rate from the
five PEcAn model esemble simulations</div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Shawn Serbin, Anthony Walker.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
