<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>The PEcAn RTM package • PEcAnRTM</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="The PEcAn RTM package">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">PEcAnRTM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.9.0</small>

    <a href="../index.html" style="padding: 0em 1em">← Up</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/pecanrtm.vignette.html">The PEcAn RTM package</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>The PEcAn RTM package</h1>
                        <h4 data-toc-skip class="author">Alexey
Shiklomanov</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/PecanProject/pecan/blob/develop/modules/rtm/vignettes/pecanrtm.vignette.Rmd" class="external-link"><code>vignettes/pecanrtm.vignette.Rmd</code></a></small>
      <div class="d-none name"><code>pecanrtm.vignette.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The PEcAnRTM package provides tools for analyses involving common
radiative transfer models. The highlights of this package are its
ability to efficiently run a suite of related leaf and canopy radiative
transfer models, as well as to perform maximum likelihood and,
particularly, Bayesian inversions of these models.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>The easiest way to install this package is via
<code>install_github</code> from the <code>devtools</code> package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"devtools"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/" class="external-link">devtools</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"ashiklom/pecan"</span>, subdir <span class="op">=</span> <span class="st">"modules/rtm"</span><span class="op">)</span></span>
<span><span class="co"># Defaults to branch 'master'. </span></span>
<span><span class="co"># For custom branches, add `ref = "branchname"`</span></span></code></pre></div>
<p>This package relies on a modern (&gt;= 2003) Fortran compiler, as
determined by your R installation. On most Unix systems, this is
standard, but R may specify a particular compiler version that you don’t
have, resulting in an installation error. To fix this, simply add the
following to your system <code>~/R/Makevars</code> file.</p>
<pre><code><span><span class="va">FC</span> <span class="op">=</span> <span class="va">gfortran</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="overview-of-features">Overview of features<a class="anchor" aria-label="anchor" href="#overview-of-features"></a>
</h2>
<div class="section level3">
<h3 id="simulating-reflectance">Simulating reflectance<a class="anchor" aria-label="anchor" href="#simulating-reflectance"></a>
</h3>
<p>Available radiative transfer models are called by passing a vector of
their parameters. Similar models with different versions (e.g. PROSPECT
4, 5, 5B) also have a “version” argument. These models return a matrix
of reflectance, transmittance, and/or absorption spectra (depending on
the model) at 1 nm resolution over the wavelength range 400 to 2500
nm.</p>
<p>The PROSPECT family of models returns the reflectance (column 1) and
transmittance (column 2) for an individual leaf as a function of 4 to 6
parameters (depending on the version).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pecanproject.github.io" class="external-link">PEcAnRTM</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'PEcAnRTM'</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:graphics':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     matplot</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wl</span> <span class="op">&lt;-</span> <span class="fl">400</span><span class="op">:</span><span class="fl">2500</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"N"</span> <span class="op">=</span> <span class="fl">1.4</span>, <span class="st">"Cab"</span> <span class="op">=</span> <span class="fl">40</span>, <span class="st">"Car"</span> <span class="op">=</span> <span class="fl">15</span>,</span>
<span>  <span class="st">"Cbrown"</span> <span class="op">=</span> <span class="fl">0.5</span>, <span class="st">"Cw"</span> <span class="op">=</span> <span class="fl">0.002</span>, <span class="st">"Cm"</span> <span class="op">=</span> <span class="fl">0.004</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prospect.html">prospect</a></span><span class="op">(</span><span class="va">params</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="op">-</span><span class="fl">4</span><span class="op">)</span><span class="op">]</span>, version <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">p4</span></span></code></pre></div>
<pre><code><span><span class="co">##     reflectance transmittance</span></span>
<span><span class="co">## 400  0.04099898  0.0001814716</span></span>
<span><span class="co">## 401  0.04103723  0.0001699630</span></span>
<span><span class="co">## 402  0.04106248  0.0001575602</span></span>
<span><span class="co">## 403  0.04111370  0.0001452140</span></span>
<span><span class="co">## 404  0.04120401  0.0001348522</span></span>
<span><span class="co">## ...</span></span>
<span><span class="co">##      reflectance transmittance</span></span>
<span><span class="co">## 2496   0.1422667     0.2801837</span></span>
<span><span class="co">## 2497   0.1417965     0.2792691</span></span>
<span><span class="co">## 2498   0.1420623     0.2795135</span></span>
<span><span class="co">## 2499   0.1413868     0.2782765</span></span>
<span><span class="co">## 2500   0.1418849     0.2788870</span></span></code></pre>
<p>Notice only the first and last few lines of the spectra are printed,
and the wavelength is annotated on the side. This is is because all RTM
simulations in this package are of a special matrix class
<code>spectra</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">p4</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "spectra" "matrix"</span></span></code></pre>
<p>This class allows traditional subsetting via index with single
brackets (<code>[]</code>), as well as subsetting by wavelength with
double brackets.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p4</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">50</span>, <span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##     reflectance</span></span>
<span><span class="co">## 400  0.04099898</span></span>
<span><span class="co">## 401  0.04103723</span></span>
<span><span class="co">## 402  0.04106248</span></span>
<span><span class="co">## 403  0.04111370</span></span>
<span><span class="co">## 404  0.04120401</span></span>
<span><span class="co">## ...</span></span>
<span><span class="co">##     reflectance</span></span>
<span><span class="co">## 445  0.04545556</span></span>
<span><span class="co">## 446  0.04542921</span></span>
<span><span class="co">## 447  0.04540287</span></span>
<span><span class="co">## 448  0.04537665</span></span>
<span><span class="co">## 449  0.04533726</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p4</span><span class="op">[[</span><span class="fl">500</span><span class="op">:</span><span class="fl">520</span>, <span class="fl">2</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##     transmittance</span></span>
<span><span class="co">## 500   0.008937186</span></span>
<span><span class="co">## 501   0.010279518</span></span>
<span><span class="co">## 502   0.011772740</span></span>
<span><span class="co">## 503   0.013438540</span></span>
<span><span class="co">## 504   0.015276985</span></span>
<span><span class="co">## ...</span></span>
<span><span class="co">##     transmittance</span></span>
<span><span class="co">## 516    0.05336301</span></span>
<span><span class="co">## 517    0.05776873</span></span>
<span><span class="co">## 518    0.06224375</span></span>
<span><span class="co">## 519    0.06679217</span></span>
<span><span class="co">## 520    0.07136411</span></span></code></pre>
<p>The package also provides special plotting (<code>plot</code>,
<code>matplot</code>) and combining (<code>cbind</code>) methods. Note
that the <code>cbind</code> method automatically matches wavelengths,
which facilitates working with spectra with different wavelengths.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prospect.html">prospect</a></span><span class="op">(</span><span class="va">params</span><span class="op">[</span><span class="op">-</span><span class="fl">4</span><span class="op">]</span>, version <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">p5b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prospect.html">prospect</a></span><span class="op">(</span><span class="va">params</span>, version <span class="op">=</span> <span class="st">"5B"</span><span class="op">)</span></span>
<span><span class="va">p_multi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">p4</span>, <span class="va">p5</span>, <span class="va">p5b</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/matplot.html">matplot</a></span><span class="op">(</span><span class="va">p_multi</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, col <span class="op">=</span> <span class="fl">2</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/matplot.html">matplot</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p_multi</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">6</span><span class="op">)</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, col <span class="op">=</span> <span class="fl">3</span>,  add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Reflectance"</span>, <span class="st">"Transmittance"</span><span class="op">)</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"top"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"4"</span>, <span class="st">"5"</span>, <span class="st">"5B"</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="pecanrtm.vignette_files/figure-html/unnamed-chunk-5-1.png" width="80%"></p>
<p>The SAIL family of models returns the bidirectional (1),
hemispherical directional (2), directional hemispherical (3), and
bidirectional hemispherical (4) reflectance factors for a canopy with a
given set of approximately 20 parameters. It is often coupled to the
PROSPECT model as PRO4SAIL. (Again, note that the return type is a
<code>spectra</code>, which leads <code>matplot</code> to automatically
put wavelengths on the x axis.)</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sail.params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/defparam.html">defparam</a></span><span class="op">(</span><span class="st">"pro4sail"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">sail.params</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        N      Cab      Car   Cbrown       Cw       Cm    LIDFa    LIDFb </span></span>
<span><span class="co">##    1.500   40.000    8.000    0.000    0.010    0.009   -0.350   -0.150 </span></span>
<span><span class="co">## TypeLIDF      LAI        q      tts      tto      psi    psoil </span></span>
<span><span class="co">##    1.000    3.000    0.010   30.000   10.000    0.000    1.000</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p4s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pro4sail.html">pro4sail</a></span><span class="op">(</span><span class="va">sail.params</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/matplot.html">matplot</a></span><span class="op">(</span><span class="va">p4s</span>, xlab<span class="op">=</span><span class="st">"Wavelength (nm)"</span>, ylab<span class="op">=</span><span class="st">"Reflectance"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, col<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, lty<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="pecanrtm.vignette_files/figure-html/unnamed-chunk-6-1.png" width="80%"></p>
<p>The above example illustrates the use of <code>defparam</code> to get
the default parameters for a particular model. Similarly,
<code>model.list</code> is a <code>data.frame</code> containing all
currently available models.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">model.list</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          modname modcode         fullname</span></span>
<span><span class="co">## 1     prospect_d    1153       PROSPECT D</span></span>
<span><span class="co">## 2    prospect_5b    1152      PROSPECT 5B</span></span>
<span><span class="co">## 3     prospect_5    1151       PROSPECT 5</span></span>
<span><span class="co">## 4     prospect_4    1141       PROSPECT 4</span></span>
<span><span class="co">## 5       pro4sail    2111         PRO4SAIL</span></span>
<span><span class="co">## 6      pro4saild    2113        PRO4SAILD</span></span>
<span><span class="co">##                                                                          par.names</span></span>
<span><span class="co">## 1                                                     N Cab Car Canth Cbrown Cw Cm</span></span>
<span><span class="co">## 2                                                           N Cab Car Cbrown Cw Cm</span></span>
<span><span class="co">## 3                                                                  N Cab Car Cw Cm</span></span>
<span><span class="co">## 4                                                                      N Cab Cw Cm</span></span>
<span><span class="co">## 5            N Cab Car Cbrown Cw Cm LIDFa LIDFb TypeLIDF_r LAI q tts tto psi psoil</span></span>
<span><span class="co">## 6      N Cab Car Canth Cbrown Cw Cm LIDFa LIDFb TypeLIDF_r LAI q tts tto psi psoil</span></span>
<span><span class="co">##                                                                                                                         par.default</span></span>
<span><span class="co">## 1                                                                              N=1.5 Cab=40 Car=8 Canth=8 Cbrown=0 Cw=0.01 Cm=0.009</span></span>
<span><span class="co">## 2                                                                                      N=1.5 Cab=40 Car=8 Cbrown=0 Cw=0.01 Cm=0.009</span></span>
<span><span class="co">## 3                                                                                               N=1.5 Cab=40 Car=8 Cw=0.01 Cm=0.009</span></span>
<span><span class="co">## 4                                                                                                     N=1.5 Cab=40 Cw=0.01 Cm=0.009</span></span>
<span><span class="co">## 5          N=1.5 Cab=40 Car=8 Cbrown=0 Cw=0.01 Cm=0.009 LIDFa=-0.35 LIDFb=-0.15 TypeLIDF=1 LAI=3 q=0.01 tts=30 tto=10 psi=0 psoil=1</span></span>
<span><span class="co">## 6  N=1.5 Cab=40 Car=8 Canth=1 Cbrown=0 Cw=0.01 Cm=0.009 LIDFa=-0.35 LIDFb=-0.15 TypeLIDF=1 LAI=3 q=0.01 tts=30 tto=10 psi=0 psoil=1</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="inversion">Inversion<a class="anchor" aria-label="anchor" href="#inversion"></a>
</h3>
<p>A novel feature of this package is the ability to perform a Bayesian
inversion of a Radiative Transfer Model. Here are several advantages of
the Bayesian approach:</p>
<ul>
<li>
<strong>Parameter uncertainty:</strong> The output of a Bayesian
analysis is a full joint probability distribution of the model
parameters, which includes a robust estimate of their uncertainy and
covariance between parameters.</li>
<li>
<strong>Prior knowledge:</strong> If previous, independent estimates
of parameters are available, these can be used to inform the model.</li>
<li>
<strong>Partitioning variability:</strong> Random effects models
provide a powerful framework for understanding the sources of
variability and uncertainty in a data set.</li>
</ul>
<p>An inversion can be performed using the <code>invert.auto</code>
function, which uses the Metropolis Hastings MCMC algorithm to invert an
arbitrary model. There are a lot of configuration options to
<code>invert.auto</code>, so the recommended way to perform an inversion
is to start with a default settings list, provided by the package
itself. In the following sample, we demonstrate the default inversion of
the PROSPECT model.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">invert.options</span> <span class="op">&lt;-</span> <span class="va">default.settings.prospect</span></span></code></pre></div>
<p>The model to be inverted is, in this case, just a one-line call to
the PROSPECT 5 model with the params vector. It returns a vector of
reflectance values. The requirement is that the “model” output be as
long as the length (or number of rows) of the observation vector (or
matrix). In this case, the PROSPECT model returns 2101 reflectance
values, so our observation also has to have this many points.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">invert.options</span><span class="op">$</span><span class="va">model</span></span></code></pre></div>
<pre><code><span><span class="co">## function (params, seed = NULL) </span></span>
<span><span class="co">## prospect(params, 5)[, 1]</span></span>
<span><span class="co">## &lt;bytecode: 0x559f1d7656e0&gt;</span></span>
<span><span class="co">## &lt;environment: namespace:PEcAnRTM&gt;</span></span></code></pre>
<p>The recommended way to set settings is to start with a default object
and modify it. For example, in the following block, we reduce the length
of the run to make it go a little faster. <code>threshold = ...</code>
sets the maximum value of the multivariate Gelman Diagnostic used to
assess convergence – it defaults to 1.1, but we set it higher here for
demonstrative purposes).</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">invert.options</span><span class="op">$</span><span class="va">nchains</span> <span class="op">&lt;-</span> <span class="fl">2</span>      <span class="co"># Number of MCMC chains</span></span>
<span><span class="va">invert.options</span><span class="op">$</span><span class="va">ngibbs.max</span> <span class="op">&lt;-</span> <span class="fl">5e4</span> <span class="co"># Maximum number of iterations per chain (fails if no convergence by then)</span></span>
<span><span class="va">invert.options</span><span class="op">$</span><span class="va">do.lsq</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>    <span class="co"># Initialize with results from a fast least-squares optimization algorithm</span></span>
<span><span class="va">invert.options</span><span class="op">$</span><span class="va">threshold</span> <span class="op">&lt;-</span> <span class="fl">1.3</span>  <span class="co"># Maximum value for Gelman diagnostic</span></span></code></pre></div>
<p>The full list of inversion options is below. See the documentation
for <code>invert.auto</code> for a full description of each of
these.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">invert.options</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "model"          "inits.function" "prior.function" "param.mins"    </span></span>
<span><span class="co">##  [5] "param.maxs"     "ngibbs"         "nchains"        "burnin"        </span></span>
<span><span class="co">##  [9] "ngibbs.max"     "ngibbs.min"     "ngibbs.step"    "return.samples"</span></span>
<span><span class="co">## [13] "target"         "do.lsq"         "save.samples"   "quiet"         </span></span>
<span><span class="co">## [17] "adapt"          "adj_min"        "threshold"</span></span></code></pre>
<p>Now, we load some test data (for <em>Acer rubrum</em> leaves
(<code>testspec_ACRU</code>, accessible through
<code>data(testspec)</code>).</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">testspec</span><span class="op">)</span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="va">testspec_ACRU</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">wl</span>, <span class="va">observed</span>, xlab<span class="op">=</span><span class="st">"Wavelength"</span>, ylab<span class="op">=</span><span class="st">"Reflectance"</span>, type<span class="op">=</span><span class="st">'l'</span><span class="op">)</span></span></code></pre></div>
<p><img src="pecanrtm.vignette_files/figure-html/unnamed-chunk-12-1.png" width="80%"></p>
<p>To perform an inversion, just pass the observation matrix and the
inversion settings into <code>invert.auto</code>.
<code>quiet = TRUE</code> suppresses the progress bar, which is done
here to clean up the knitted document. We also set
<code>parallel = FALSE</code> here because this vignette is rebuilt on
shared hardware where only one processor might be available; for runs on
your own machine, you will probably want to set it TRUE to use all the
cores on your machine.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="st">"inversion.output.rds"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">inversion.output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"inversion.output.rds"</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">inversion.output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/invert.auto.html">invert.auto</a></span><span class="op">(</span>observed <span class="op">=</span> <span class="va">observed</span>,</span>
<span>                                    invert.options <span class="op">=</span> <span class="va">invert.options</span>,</span>
<span>                                    quiet <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                    parallel <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">inversion.output</span>, <span class="st">"inversion.output.rds"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required namespace: minpack.lm</span></span></code></pre>
<pre><code><span><span class="co">## [1] "Running chain 1 of 2"</span></span></code></pre>
<pre><code><span><span class="co">## Loading required namespace: MASS</span></span></code></pre>
<pre><code><span><span class="co">## [1] "Running chain 2 of 2"</span></span>
<span><span class="co">## [1] "The following parameters did not converge: Car (1.306), Cw (1.573)"</span></span>
<span><span class="co">## [1] "Converged with all Gelman diag &lt;= 1.001"</span></span></code></pre>
<pre><code><span><span class="co">##           N      Cab      Car       Cw       Cm residual PSRF N &gt; 1.10</span></span>
<span><span class="co">## 46 1.034063 1.047655 1.174796 1.304651 1.001482 1.075235         FALSE</span></span>
<span><span class="co">## 47 1.044040 1.042420 1.122026 1.243426 1.008934 1.057692         FALSE</span></span>
<span><span class="co">## 48 1.037438 1.025795 1.120370 1.199240 1.012572 1.055102         FALSE</span></span>
<span><span class="co">## 49 1.016022 1.020189 1.023890 1.144805 1.005341 1.053004         FALSE</span></span>
<span><span class="co">## 50 1.007550 1.004625 1.003052 1.130626 1.001551 1.050658         FALSE</span></span>
<span><span class="co">## 51 1.006932 1.001220 1.001875 1.159131 1.003434 1.049637         FALSE</span></span>
<span><span class="co">##    PSRF Cab &gt; 1.10 PSRF Car &gt; 1.10 PSRF Cw &gt; 1.10 PSRF Cm &gt; 1.10</span></span>
<span><span class="co">## 46           FALSE            TRUE           TRUE          FALSE</span></span>
<span><span class="co">## 47           FALSE            TRUE           TRUE          FALSE</span></span>
<span><span class="co">## 48           FALSE            TRUE           TRUE          FALSE</span></span>
<span><span class="co">## 49           FALSE           FALSE           TRUE          FALSE</span></span>
<span><span class="co">## 50           FALSE           FALSE           TRUE          FALSE</span></span>
<span><span class="co">## 51           FALSE           FALSE           TRUE          FALSE</span></span>
<span><span class="co">##    PSRF residual &gt; 1.10</span></span>
<span><span class="co">## 46                FALSE</span></span>
<span><span class="co">## 47                FALSE</span></span>
<span><span class="co">## 48                FALSE</span></span>
<span><span class="co">## 49                FALSE</span></span>
<span><span class="co">## 50                FALSE</span></span>
<span><span class="co">## 51                FALSE</span></span>
<span><span class="co">## [1] "Converged with all Gelman diag &lt;= 1.000"</span></span></code></pre>
<p>The output of <code>invert.auto</code> is a list of two objects: A
list of summary statistics for each parameter and an
<code>mcmc.list</code> object of the samples for diagnostic purposes or
calculation of other summary statistics.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">inversion.output</span><span class="op">$</span><span class="va">samples</span>, auto.layout<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="pecanrtm.vignette_files/figure-html/unnamed-chunk-14-1.png" width="80%"><img src="pecanrtm.vignette_files/figure-html/unnamed-chunk-14-2.png" width="80%"><img src="pecanrtm.vignette_files/figure-html/unnamed-chunk-14-3.png" width="80%"></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">samples.mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">inversion.output</span><span class="op">$</span><span class="va">samples</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">2000</span><span class="op">:</span><span class="fl">0</span><span class="op">)</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">samples.mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">params.prospect5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">samples.mat</span>, pch<span class="op">=</span><span class="st">"."</span><span class="op">)</span></span></code></pre></div>
<p><img src="pecanrtm.vignette_files/figure-html/unnamed-chunk-14-4.png" width="80%"></p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">inversion.output</span><span class="op">$</span><span class="va">results</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"mu"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">inversion.output</span><span class="op">$</span><span class="va">results</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="va">prospect.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prospect.html">prospect</a></span><span class="op">(</span><span class="va">means</span>, <span class="fl">5</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>  <span class="co"># reflectance</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">wl</span>, <span class="va">observed</span>, type<span class="op">=</span><span class="st">'l'</span>, col<span class="op">=</span><span class="fl">1</span>, xlab<span class="op">=</span><span class="st">"wavelength (nm)"</span>, ylab<span class="op">=</span><span class="st">"reflectance"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">wl</span>, <span class="va">prospect.sim</span>, type<span class="op">=</span><span class="st">'l'</span>, col<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"observed"</span>, <span class="st">"predicted"</span><span class="op">)</span>, lty<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="pecanrtm.vignette_files/figure-html/unnamed-chunk-14-5.png" width="80%"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mike Dietze, Shawn Serbin, Alexey Shiklomanov.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
