<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Generic function to query database — db.query • PEcAn.DB</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Generic function to query database — db.query"><meta name="description" content="Given a connection and a query, will return a query as a data frame. Either con or params need
to be specified. If both are specified it will use con."><meta property="og:description" content="Given a connection and a query, will return a query as a data frame. Either con or params need
to be specified. If both are specified it will use con."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">PEcAn.DB</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.8.1.9000</small>

    <a href="../index.html" style="padding: 0em 1em">← Up</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/betydb_access.html">BETYdb Access</a></li>
    <li><a class="dropdown-item" href="../articles/create_sites.geometry.html">Create PostGIS polygon</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Generic function to query database</h1>
      <small class="dont-index">Source: <a href="https://github.com/PecanProject/pecan/blob/develop/base/db/R/utils_db.R" class="external-link"><code>R/utils_db.R</code></a></small>
      <div class="d-none name"><code>db.query.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Given a connection and a query, will return a query as a data frame. Either con or params need
to be specified. If both are specified it will use con.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">db.query</span><span class="op">(</span><span class="va">query</span>, con <span class="op">=</span> <span class="cn">NULL</span>, params <span class="op">=</span> <span class="cn">NULL</span>, values <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-query">query<a class="anchor" aria-label="anchor" href="#arg-query"></a></dt>
<dd><p>SQL query string</p></dd>


<dt id="arg-con">con<a class="anchor" aria-label="anchor" href="#arg-con"></a></dt>
<dd><p>Database connection object</p></dd>


<dt id="arg-params">params<a class="anchor" aria-label="anchor" href="#arg-params"></a></dt>
<dd><p>Named list of database connection parameters. See
`params` argument to [db.open()].</p></dd>


<dt id="arg-values">values<a class="anchor" aria-label="anchor" href="#arg-values"></a></dt>
<dd><p>If using prepared statements, a list of values to
substitute into the query. If `NULL` (default), execute the
query directly. See this function's "Details", and documentation
for [DBI::dbBind()].</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>data frame with query results</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This function supports prepared statements, which provide a way to
pass data into SQL queries without the risk of SQL injection
attacks. Whenever you are tempted to do something like this:</p>
<p>“`
db.query(paste0(
  "SELECT * FROM table WHERE mycol = ", somevalue,
  " AND othercol = ", othervalue
), con = con)
“`</p>
<p>...use a prepared query instead:</p>
<p>“`
db.query(
  "SELECT * FROM table WHERE mycol = $1 AND othercol = $2",
  values = list(somevalue, othervalue),
  con = con
)
“`</p>
<p>Besides preventing SQL injections, prepared statements also ensure
that the input and target types are compatible.</p>
<p>Prepared statements provide an efficient way to operate on
multiple values at once. For example, the following will return
all the models whose revision is either "git", "46", or "unk":</p>
<p>“`
db.query(
  "SELECT * FROM models WHERE revision = $1",
  values = list(c("git", "46", "unk")),
  con = con
)
“`</p>
<p>...and here is an example of inserting multiple values of a given
trait for a given species:</p>
<p>“`
db.query(
  "INSERT INTO traits (specie_id, variable_id, mean, n) VALUES ($1, $2, $3)",
  values = list(938, 396, c(1.7, 3.9, 4.5), 1),
  con = con
)
“`</p>
<p>Note that prepared statements **can not be used to select tables
or columns**. In other words, the following _will not work_
because of the following placeholders, the only valid one is `$5`:</p>
<p>“`
# This will not work!
db.query(
  "SELECT $1, $2 FROM $3 WHERE $4 = $5",
  values = list("col1", "col2", "mytable", "somecolumn", "somevalue")
)
“`</p>
<p>Note that prepared statements **are not supported by the
`RPostgreSQL` package**; only by the newer `RPostgres` package.</p>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Rob Kooper, Alexey Shiklomanov</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="fu">db.query</span><span class="op">(</span><span class="st">"SELECT count(id) FROM traits;"</span>, params <span class="op">=</span> <span class="va">settings</span><span class="op">$</span><span class="va">database</span><span class="op">$</span><span class="va">bety</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Prepared statements</span></span></span>
<span class="r-in"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="db.open.html">db.open</a></span><span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">database</span><span class="op">$</span><span class="va">bety</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">db.query</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="st">"SELECT * FROM table WHERE mycol = $1 AND othercol = $2"</span>,</span></span>
<span class="r-in"><span>  values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">somevalue</span>, <span class="va">othervalue</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  con <span class="op">=</span> <span class="va">con</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Select multiple values at once; rbind the result</span></span></span>
<span class="r-in"><span><span class="fu">db.query</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="st">"SELECT * FROM models WHERE revision = $1"</span>,</span></span>
<span class="r-in"><span>  values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"git"</span>, <span class="st">"46"</span>, <span class="st">"unk"</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  con <span class="op">=</span> <span class="va">con</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Efficiently insert multiple values into a table</span></span></span>
<span class="r-in"><span><span class="fu">db.query</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="st">"INSERT INTO traits (specie_id, variable_id, mean, n) VALUES ($1, $2, $3, $4)"</span>,</span></span>
<span class="r-in"><span>  values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">938</span>, <span class="fl">396</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  con <span class="op">=</span> <span class="va">con</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by David LeBauer, Mike Dietze, Rob Kooper, Shawn Serbin, Elizabeth Cowdery, Ankur Desai, Istem Fer, Alexey Shiklomanov, Tony Gardella, Chris Black, Liam Burke, Ryan Kelly, Dan Wang, Carl Davidson, Xiaohui Feng, Shashank Singh.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

